<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/styles/styleIndex.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" type="image/png" href="/img/favicon.png">
    <title>Dashboard Account - equo compenso</title>
</head>
<body class="account-page">

    <header>

        <section class="header-img">
            <img src="/img/logo2.png" alt="logo">
        </section>

        <div class="ls">
            <ul>
                <li><a href="/">home</a></li>
                <li><a href="/chi-siamo">chi siamo</a></li>
                <li><a href="/calcola">calcola</a></li>
                <li><a href="/norme">norme</a></li>
                <li><button onclick="window.location.href='/?login=1'">login</button></li>
                <li><button onclick="window.location.href='/?register=1'">registrati</button></li>
            </ul>
        </div>

    </header>

    <main class="account-main-wrap">
        <div class="account-mobile-bar" aria-label="Menu account mobile">
            <button id="accountMenuToggle" class="account-mobile-hamburger" type="button" aria-label="Apri menu" aria-expanded="false">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <div class="account-mobile-brand" onclick="window.location.href='/'" role="button" tabindex="0">
                <img src="/img/logo2.png" alt="equo compenso" class="account-mobile-logo">
            </div>
            <div class="account-mobile-user" aria-label="Utente">
                <span class="account-mobile-avatar">
                    <img id="mobile-user-photo" class="nav-user-photo" alt="Foto profilo" style="display:none;">
                    <span class="mobile-user-initials">?</span>
                </span>
            </div>
        </div>

        <div class="account-layout">
            <div id="accountSidebarBackdrop" class="account-sidebar-backdrop" style="display:none;"></div>
            <aside class="account-sidebar">
                <div class="account-sidebar-title">Menu</div>
                <a class="account-nav-item" href="/"><i class="fas fa-house"></i><span>Home</span></a>
                <a class="account-nav-item" href="/chi-siamo"><i class="fas fa-users"></i><span>Chi siamo</span></a>
                <a class="account-nav-item" href="/calcola"><i class="fas fa-calculator"></i><span>Calcola</span></a>
                <a class="account-nav-item" href="/norme"><i class="fas fa-book"></i><span>Norme</span></a>

                <div class="account-sidebar-title">Gestione Account</div>
                <button class="account-nav-item active" data-view="profile"><i class="fas fa-id-card"></i><span>Informazioni Personali</span></button>
                <button class="account-nav-item" data-view="professional"><i class="fas fa-briefcase"></i><span>Dati Professionali</span></button>
                <button class="account-nav-item" data-view="security"><i class="fas fa-shield-halved"></i><span>Sicurezza e Password</span></button>
                <button class="account-nav-item" data-view="calculations"><i class="fas fa-clock-rotate-left"></i><span>I miei Calcoli</span></button>
                <button class="account-nav-item" data-view="subscription"><i class="fas fa-credit-card"></i><span>Abbonamento</span></button>
            </aside>

            <section class="account-content">
                <div class="account-view" id="view-profile">
                    <div class="account-profile-header">
                        <div class="account-profile-head">
                            <h1>Informazioni personali</h1>
                            <p>Dati relativi alla tua identità e foto profilo utilizzati nei servizi di Equo Compenso.</p>
                        </div>
                        <div class="account-avatar-editor">
                            <div class="account-avatar-circle" id="avatarDisplay">
                                <img id="avatarImg" class="account-avatar-img" alt="Avatar" style="display:none;">
                                <span id="avatarInitials" class="account-avatar-initials">?</span>
                            </div>
                            <button id="change_photo_trigger" class="account-avatar-action" type="button" onclick="document.getElementById('avatarInput').click()">
                                <i class="fas fa-camera"></i>
                                <span>Cambia Foto</span>
                            </button>
                            <input id="avatarInput" type="file" accept="image/png,image/jpeg,image/webp" style="display:none;">
                        </div>
                    </div>

                    <div class="account-grid">
                        <div class="account-card">
                            <div class="account-card-title">Dati di Base</div>
                            <div class="account-field">
                                <label>Nome</label>
                                <input id="accNome" type="text" value="">
                            </div>
                            <div class="account-field">
                                <label>Cognome</label>
                                <input id="accCognome" type="text" value="">
                            </div>
                            <div class="account-field">
                                <label>Data di Nascita</label>
                                <input id="accDataNascita" type="date" value="">
                            </div>
                        </div>

                        <div class="account-card">
                            <div class="account-card-title">Contatti e Accesso</div>
                            <div class="account-field">
                                <label>Email</label>
                                <div class="account-inline">
                                    <input id="accEmail" type="email" value="" readonly>
                                    <span class="account-badge" id="accEmailBadge" style="display:none;">Verificata</span>
                                </div>
                            </div>
                            <div class="account-field">
                                <label>Password</label>
                                <div class="account-inline">
                                    <input type="password" value="********" readonly>
                                    <button class="account-link-btn" type="button" onclick="setActiveView('security')">Aggiorna</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="account-view" id="view-professional" style="display:none;">
                    <div class="account-profile-header">
                        <div class="account-profile-head">
                            <h1>Dati professionali</h1>
                            <p>Informazioni relative alla tua attività professionale utilizzate nei servizi di Equo Compenso.</p>
                        </div>
                    </div>

                    <div class="account-grid">
                        <div class="account-card">
                            <div class="account-card-title">Professione</div>
                            <div class="account-field">
                                <label>Nome Studio / Azienda</label>
                                <input id="accStudioNome" type="text" value="" placeholder="Es. Studio Rossi & Partners">
                            </div>
                            <div class="account-field">
                                <label>Ruolo Professionale</label>
                                <select id="accProfessione">
                                    <option value="commercialista">Commercialista</option>
                                    <option value="avvocato">Avvocato</option>
                                    <option value="ingegnere">Ingegnere</option>
                                    <option value="architetto">Architetto</option>
                                    <option value="geometra">Geometra</option>
                                    <option value="perito">Perito industriale</option>
                                    <option value="ragioniere">Ragioniere</option>
                                    <option value="consulente_lavoro">Consulente del lavoro</option>
                                </select>
                            </div>
                            <div class="account-field">
                                <label>Ordine di Appartenenza</label>
                                <input id="accOrdine" type="text" value="" placeholder="(non disponibile)" readonly>
                            </div>
                        </div>

                        <div class="account-card">
                            <div class="account-card-title">Sede Ufficio</div>
                            <div class="account-field">
                                <label>Indirizzo</label>
                                <input id="accSedeIndirizzo" type="text" value="" placeholder="Via / Piazza, numero">
                            </div>
                            <div class="account-field">
                                <label>Città</label>
                                <input id="accSedeCitta" type="text" value="" placeholder="Comune">
                            </div>
                            <div class="account-field">
                                <label>CAP</label>
                                <input id="accSedeCap" type="text" value="" placeholder="00000">
                            </div>
                            <div class="account-field">
                                <label>Provincia</label>
                                <input id="accSedeProvincia" type="text" value="" placeholder="Es. ME">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="account-view" id="view-security" style="display:none;">
                    <div class="account-card">
                        <div class="account-card-title">Sicurezza e Password</div>
                        <div class="account-muted">Aggiorna la password del tuo account. Per motivi di sicurezza è richiesta la password attuale.</div>
                    </div>

                    <div class="account-card">
                        <div class="account-card-title">Modifica Password</div>
                        <div class="account-grid">
                            <div class="account-field">
                                <label>Password attuale</label>
                                <input id="securityCurrentPassword" type="password" value="" autocomplete="current-password">
                            </div>
                            <div class="account-field">
                                <label>Nuova password</label>
                                <input id="securityNewPassword" type="password" value="" autocomplete="new-password">
                            </div>
                            <div class="account-field">
                                <label>Conferma nuova password</label>
                                <input id="securityConfirmPassword" type="password" value="" autocomplete="new-password">
                            </div>
                            <div class="account-field">
                                <label>&nbsp;</label>
                                <button id="securityChangePasswordBtn" class="account-save-btn" type="button" onclick="handleChangePassword()">Aggiorna Password</button>
                            </div>
                        </div>
                        <div id="securityMessage" class="account-muted" style="display:none;"></div>
                    </div>
                </div>

                <div class="account-view" id="view-calculations" style="display:none;">
                    <div class="account-card">
                        <div class="account-card-title">I miei Calcoli</div>
                        <div class="account-calcs-toolbar">
                            <div class="account-search-wrap">
                                <i class="fas fa-magnifying-glass"></i>
                                <input id="calcSearch" class="account-search-input" type="text" placeholder="Cerca per nome pratica o data (es. 2025-01-07)...">
                            </div>
                        </div>

                        <div class="account-table-wrap">
                            <table class="account-table" aria-label="Tabella calcoli">
                                <thead>
                                    <tr>
                                        <th>Nome File</th>
                                        <th>Data Creazione</th>
                                        <th>Valore Pratica</th>
                                        <th>Compenso</th>
                                        <th>Azioni</th>
                                    </tr>
                                </thead>
                                <tbody id="calcTableBody"></tbody>
                            </table>
                            <div id="calcEmpty" class="account-muted" style="display:none;">Nessun calcolo disponibile al momento.</div>
                        </div>
                    </div>
                </div>

                <div class="account-view" id="view-subscription" style="display:none;">
                    <div class="account-card">
                        <div class="account-card-title">Abbonamento</div>
                        <div class="account-muted">al momento non ci sono abbonamenti disponibili.</div>
                    </div>
                </div>

            </section>
        </div>

        <div class="account-save-wrap">
            <button id="save_all_changes" class="account-save-btn" type="button" onclick="saveAccount()">Salva Modifiche</button>
        </div>
    </main>

    <script>
        function parseJwt(token) {
            if (!token || typeof token !== 'string') return {};
            const parts = token.split('.');
            if (parts.length !== 3) return {};
            try {
                return JSON.parse(atob(parts[1].replace(/-/g, '+').replace(/_/g, '/')));
            } catch {
                return {};
            }
        }

        async function apiRequest(path, options = {}) {
            const token = localStorage.getItem('authToken');
            const headers = Object.assign({ 'Content-Type': 'application/json' }, options.headers || {});
            if (token) headers.Authorization = `Bearer ${token}`;

            const res = await fetch(path, Object.assign({}, options, { headers }));
            let data = null;
            try {
                data = await res.json();
            } catch {
                data = null;
            }
            if (!res.ok) {
                const msg = data && data.error ? data.error : 'Errore server';
                throw new Error(msg);
            }
            return data;
        }

        async function updateHeaderUser() {
            const token = localStorage.getItem('authToken');
            const user = parseJwt(token);
            const headerUl = document.querySelector('.ls ul');
            if (!headerUl) return;
            const isLogged = !!token && (!!user.sub || !!user.id || !!user.email);

            function initialsFrom(u) {
                const nome = (u && u.nome ? String(u.nome) : '').trim();
                const cognome = (u && u.cognome ? String(u.cognome) : '').trim();
                if (nome || cognome) {
                    return `${nome.charAt(0)}${cognome.charAt(0)}`.toUpperCase();
                }
                const email = (u && u.email ? String(u.email) : '').trim();
                if (email) return email.charAt(0).toUpperCase();
                return 'U';
            }

            async function syncNavAvatar() {
                const img = document.getElementById('nav-user-photo');
                const initials = document.querySelector('.nav-user-initials');
                const mobileImg = document.getElementById('mobile-user-photo');
                const mobileInitials = document.querySelector('.mobile-user-initials');
                if (!img || !initials) return;

                let u = user || {};
                try {
                    const me = await apiRequest('/api/me', { method: 'GET' });
                    if (me && me.user) u = me.user;
                } catch {
                    u = user || {};
                }

                const avatarUrl = u && u.avatar_url ? String(u.avatar_url) : '';
                if (avatarUrl) {
                    img.src = avatarUrl;
                    img.style.display = '';
                    initials.style.display = 'none';

                    if (mobileImg && mobileInitials) {
                        mobileImg.src = avatarUrl;
                        mobileImg.style.display = '';
                        mobileInitials.style.display = 'none';
                    }
                } else {
                    img.removeAttribute('src');
                    img.style.display = 'none';
                    initials.textContent = initialsFrom(u);
                    initials.style.display = '';

                    if (mobileImg && mobileInitials) {
                        mobileImg.removeAttribute('src');
                        mobileImg.style.display = 'none';
                        mobileInitials.textContent = initialsFrom(u);
                        mobileInitials.style.display = '';
                    }
                }
            }

            function isAuthLi(li) {
                const txt = (li.textContent || '').trim().toLowerCase();
                if (txt === 'login' || txt === 'registrati') return true;
                const btn = li.querySelector('button');
                if (btn && btn.onclick) {
                    const fn = btn.onclick.toString();
                    if (fn.includes('login') || fn.includes('openRegisterModal') || fn.includes('register')) return true;
                }
                const a = li.querySelector('a');
                if (a) {
                    const href = (a.getAttribute('href') || '').toLowerCase();
                    if (href.includes('login') || href.includes('register')) return true;
                }
                return false;
            }

            if (isLogged) {
                headerUl.querySelectorAll('li').forEach(li => {
                    if (isAuthLi(li)) li.style.display = 'none';
                });
                if (!headerUl.querySelector('.user-item')) {
                    const userLi = document.createElement('li');
                    userLi.className = 'user-item';
                    userLi.innerHTML = `
                        <div class="user-dropdown">
                            <button class="user-btn" onclick="toggleUserDropdown(event)">
                                <span class="user-avatar"><img id="nav-user-photo" class="nav-user-photo" alt="Foto profilo"><span class="nav-user-initials"></span></span>
                                <span class="user-welcome-text">Ciao, ${user.nome || user.email || ''}</span>
                            </button>
                            <div id="userDropdownMenu" class="user-dropdown-menu">
                                <div class="user-menu-info">
                                    <div class="user-menu-avatar-lg"><i class="fas fa-user"></i></div>
                                    <div>
                                        <div class="user-menu-name">${(user.nome || '').trim() ? `Ciao, ${user.nome}` : 'Account'}</div>
                                        <div class="user-menu-email">${user.email || ''}</div>
                                    </div>
                                </div>
                                <div class="user-menu-items">
                                    <button class="user-menu-item" onclick="window.location.href='/dashboard?view=profile'"><i class="fas fa-user"></i><span>Il mio Profilo</span></button>
                                    <button class="user-menu-item" onclick="window.location.href='/dashboard?view=calculations'"><i class="fas fa-history"></i><span>I miei Calcoli</span></button>
                                    <button class="user-menu-item" onclick="window.location.href='/dashboard?view=security'"><i class="fas fa-gear"></i><span>Impostazioni</span></button>
                                </div>
                                <div class="user-menu-footer">
                                    <button class="user-menu-item danger" onclick="handleLogout()"><i class="fas fa-right-from-bracket"></i><span>Esci / Logout</span></button>
                                </div>
                            </div>
                        </div>
                    `;
                    headerUl.appendChild(userLi);
                }
                await syncNavAvatar();
            } else {
                headerUl.querySelectorAll('li').forEach(li => {
                    if (isAuthLi(li)) li.style.display = '';
                });
                const userLi = headerUl.querySelector('.user-item');
                if (userLi) userLi.remove();
            }
        }

        function toggleUserDropdown(event) {
            if (event) event.stopPropagation();
            const menu = document.getElementById('userDropdownMenu');
            if (!menu) return;
            menu.classList.toggle('open');
        }

        function handleLogout() {
            localStorage.removeItem('authToken');
            updateHeaderUser();
            window.location.href = '/';
        }

        function setAccountMenuOpen(open) {
            const sidebar = document.querySelector('.account-sidebar');
            const backdrop = document.getElementById('accountSidebarBackdrop');
            const toggle = document.getElementById('accountMenuToggle');
            if (!sidebar || !backdrop || !toggle) return;

            if (open) {
                sidebar.classList.add('is-open');
                backdrop.style.display = '';
                backdrop.classList.add('open');
                document.body.classList.add('account-menu-open');
                toggle.setAttribute('aria-expanded', 'true');
            } else {
                sidebar.classList.remove('is-open');
                backdrop.classList.remove('open');
                backdrop.style.display = 'none';
                document.body.classList.remove('account-menu-open');
                toggle.setAttribute('aria-expanded', 'false');
            }
        }

        function isMobileAccount() {
            return window.matchMedia && window.matchMedia('(max-width: 768px)').matches;
        }

        document.addEventListener('click', function(event) {
            if (!event.target.closest('.user-dropdown')) {
                const menu = document.getElementById('userDropdownMenu');
                if (menu) menu.classList.remove('open');
            }
        });

        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const menu = document.getElementById('userDropdownMenu');
                if (menu) menu.classList.remove('open');
                if (isMobileAccount()) {
                    setAccountMenuOpen(false);
                }
            }
        });

        function setActiveView(view) {
            document.querySelectorAll('.account-nav-item[data-view]').forEach(btn => {
                btn.classList.toggle('active', btn.getAttribute('data-view') === view);
            });
            document.querySelectorAll('.account-view').forEach(v => {
                v.style.display = v.id === `view-${view}` ? '' : 'none';
            });

            const saveWrap = document.querySelector('.account-save-wrap');
            if (saveWrap) saveWrap.style.display = (view === 'profile' || view === 'professional') ? '' : 'none';

            if (isMobileAccount()) {
                setAccountMenuOpen(false);
            }

            if (view === 'calculations') {
                loadCalculations();
            }

            const url = new URL(window.location.href);
            url.searchParams.set('view', view);
            window.history.replaceState({}, '', url);
        }

        function setSecurityMessage(message, isError) {
            const el = document.getElementById('securityMessage');
            if (!el) return;
            el.textContent = String(message || '');
            el.style.display = message ? '' : 'none';
            el.style.color = isError ? '#b00020' : '#1A535C';
            el.style.fontWeight = '700';
        }

        function setSecurityBusy(isBusy) {
            const btn = document.getElementById('securityChangePasswordBtn');
            const cur = document.getElementById('securityCurrentPassword');
            const nw = document.getElementById('securityNewPassword');
            const conf = document.getElementById('securityConfirmPassword');
            if (btn) btn.disabled = !!isBusy;
            if (cur) cur.disabled = !!isBusy;
            if (nw) nw.disabled = !!isBusy;
            if (conf) conf.disabled = !!isBusy;
        }

        async function handleChangePassword() {
            const cur = document.getElementById('securityCurrentPassword');
            const nw = document.getElementById('securityNewPassword');
            const conf = document.getElementById('securityConfirmPassword');
            if (!cur || !nw || !conf) return;

            setSecurityMessage('', false);

            const currentPassword = String(cur.value || '').trim();
            const newPassword = String(nw.value || '').trim();
            const confirmPassword = String(conf.value || '').trim();

            if (!currentPassword || !newPassword || !confirmPassword) {
                setSecurityMessage('Compila tutti i campi.', true);
                return;
            }
            if (newPassword.length < 6) {
                setSecurityMessage('La nuova password deve contenere almeno 6 caratteri.', true);
                return;
            }
            if (newPassword !== confirmPassword) {
                setSecurityMessage('La conferma della password non coincide.', true);
                return;
            }
            if (newPassword === currentPassword) {
                setSecurityMessage('La nuova password deve essere diversa da quella attuale.', true);
                return;
            }

            setSecurityBusy(true);
            try {
                await apiRequest('/api/me/password', {
                    method: 'PATCH',
                    body: JSON.stringify({ currentPassword, newPassword })
                });

                cur.value = '';
                nw.value = '';
                conf.value = '';
                setSecurityMessage('Password aggiornata correttamente.', false);
                showToast('Password aggiornata');
            } catch (e) {
                setSecurityMessage(e && e.message ? e.message : 'Errore nella modifica password.', true);
            } finally {
                setSecurityBusy(false);
            }
        }

        function formatDateTime(value) {
            if (!value) return '';
            const d = new Date(value);
            if (Number.isNaN(d.getTime())) return value;
            return d.toLocaleString('it-IT');
        }

        function showToast(message) {
            const t = document.getElementById('toast');
            if (!t) return;
            t.textContent = message;
            t.classList.add('open');
            window.clearTimeout(t._hideTimer);
            t._hideTimer = window.setTimeout(() => {
                t.classList.remove('open');
            }, 2500);
        }

        function getInitials(nome, cognome, email) {
            const n = String(nome || '').trim();
            const c = String(cognome || '').trim();
            if (n || c) {
                return `${(n[0] || '').toUpperCase()}${(c[0] || '').toUpperCase()}`.trim() || '?';
            }
            const e = String(email || '').trim();
            return e ? (e[0] || '?').toUpperCase() : '?';
        }

        function setAvatarDisplay({ avatarUrl, nome, cognome, email } = {}) {
            const img = document.getElementById('avatarImg');
            const initials = document.getElementById('avatarInitials');
            if (!img || !initials) return;

            const init = getInitials(nome, cognome, email);
            initials.textContent = init;

            if (avatarUrl) {
                img.src = avatarUrl;
                img.style.display = '';
                initials.style.display = 'none';
            } else {
                img.removeAttribute('src');
                img.style.display = 'none';
                initials.style.display = '';
            }
        }

        let calculationsCache = [];
        let searchDebounce = null;

        function escapeHtml(str) {
            return String(str || '')
                .replaceAll('&', '&amp;')
                .replaceAll('<', '&lt;')
                .replaceAll('>', '&gt;')
                .replaceAll('"', '&quot;')
                .replaceAll("'", '&#039;');
        }

        function extractValorePratica(inputJson) {
            if (!inputJson || typeof inputJson !== 'object') return '';
            const v = inputJson.valore;
            if (typeof v === 'number' && Number.isFinite(v)) return `€ ${v.toFixed(2)}`;
            if (typeof v === 'string' && v.trim()) return v;
            return '';
        }

        function extractCompenso(resultJson) {
            if (!resultJson || typeof resultJson !== 'object') return '';
            const c = resultJson.chosen;
            if (typeof c === 'number' && Number.isFinite(c)) return `€ ${c.toFixed(2)}`;
            if (typeof c === 'string' && c.trim()) return c;
            return '';
        }

        function formatCalcName(c) {
            if (c && c.name && String(c.name).trim()) return String(c.name).trim();
            const date = c && c.created_at ? formatDateTime(c.created_at) : '';
            return date ? `Calcolo ${date}` : 'Calcolo';
        }

        function renderCalculations(rows) {
            const body = document.getElementById('calcTableBody');
            const empty = document.getElementById('calcEmpty');
            if (!body || !empty) return;

            body.innerHTML = '';
            if (!rows.length) {
                empty.style.display = '';
                return;
            }
            empty.style.display = 'none';

            rows.forEach(c => {
                const tr = document.createElement('tr');
                tr.setAttribute('data-id', c.id);

                const encodedName = encodeURIComponent(formatCalcName(c));

                const nameCell = document.createElement('td');
                nameCell.innerHTML = `
                    <div class="account-cell-main">
                        <div class="account-cell-title">${escapeHtml(formatCalcName(c))}</div>
                    </div>
                `;

                const dateCell = document.createElement('td');
                dateCell.textContent = formatDateTime(c.created_at);

                const valoreCell = document.createElement('td');
                valoreCell.textContent = extractValorePratica(c.input_json);

                const compensoCell = document.createElement('td');
                compensoCell.textContent = extractCompenso(c.result_json);

                const actionsCell = document.createElement('td');
                actionsCell.innerHTML = `
                    <div class="account-actions">
                        <button class="account-icon-btn" type="button" ${c.document_id ? '' : 'disabled'} aria-label="Scarica PDF" title="Scarica PDF" onclick="handleCalcDownload('${c.document_id || ''}')">
                            <i class="fas fa-download"></i>
                        </button>
                        <button class="account-icon-btn" type="button" aria-label="Rinomina" title="Rinomina" onclick="startRenameCalc('${c.id}', '${encodedName}')">
                            <i class="fas fa-pen"></i>
                        </button>
                        <button class="account-icon-btn danger" type="button" aria-label="Elimina" title="Elimina" onclick="confirmDeleteCalc('${c.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;

                tr.appendChild(nameCell);
                tr.appendChild(dateCell);
                tr.appendChild(valoreCell);
                tr.appendChild(compensoCell);
                tr.appendChild(actionsCell);
                body.appendChild(tr);
            });
        }

        function filterCalculationsFrontend(q) {
            const term = String(q || '').trim().toLowerCase();
            if (!term) return calculationsCache;
            return calculationsCache.filter(c => {
                const name = (c.name || '').toLowerCase();
                const date = (c.created_at ? String(c.created_at) : '').toLowerCase();
                const dateFmt = formatDateTime(c.created_at).toLowerCase();
                return name.includes(term) || date.includes(term) || dateFmt.includes(term);
            });
        }

        async function loadCalculations(query = '') {
            const body = document.getElementById('calcTableBody');
            const empty = document.getElementById('calcEmpty');
            if (!body || !empty) return;

            empty.style.display = 'none';
            body.innerHTML = `
                <tr>
                    <td colspan="5" class="account-muted">Caricamento...</td>
                </tr>
            `;

            try {
                const url = new URL('/api/v1/calculations', window.location.origin);
                if (query && String(query).trim()) url.searchParams.set('q', String(query).trim());
                const data = await apiRequest(url.pathname + url.search, { method: 'GET' });
                calculationsCache = (data && data.calculations) ? data.calculations : [];
                renderCalculations(filterCalculationsFrontend(query));
            } catch (e) {
                body.innerHTML = '';
                empty.style.display = '';
                empty.textContent = e && e.message ? e.message : 'Errore nel caricamento dei calcoli.';
            }
        }

        function handleCalcDownload(documentId) {
            if (!documentId) return;
            downloadDocument(documentId, 'pdf');
        }

        function startRenameCalc(calcId, currentName) {
            const tr = document.querySelector(`tr[data-id="${calcId}"]`);
            if (!tr) return;
            const nameTd = tr.querySelector('td');
            if (!nameTd) return;
            let decoded = '';
            try {
                decoded = decodeURIComponent(String(currentName || ''));
            } catch {
                decoded = String(currentName || '');
            }
            const safe = String(decoded || '').trim();
            nameTd.innerHTML = `
                <div class="account-rename">
                    <input class="account-rename-input" type="text" value="${escapeHtml(safe)}" />
                    <button class="account-link-btn" type="button" onclick="saveRenameCalc('${calcId}')">Salva</button>
                    <button class="account-link-btn" type="button" onclick="cancelRenameCalc()">Annulla</button>
                </div>
            `;
        }

        function cancelRenameCalc() {
            renderCalculations(filterCalculationsFrontend((document.getElementById('calcSearch') || {}).value || ''));
        }

        async function saveRenameCalc(calcId) {
            const tr = document.querySelector(`tr[data-id="${calcId}"]`);
            if (!tr) return;
            const input = tr.querySelector('.account-rename-input');
            const name = input ? input.value.trim() : '';
            if (!name) {
                alert('Inserisci un nome valido.');
                return;
            }

            try {
                await apiRequest(`/api/v1/calculations/${calcId}/rename`, {
                    method: 'PATCH',
                    body: JSON.stringify({ name })
                });
                const idx = calculationsCache.findIndex(x => x.id === calcId);
                if (idx >= 0) calculationsCache[idx].name = name;
                renderCalculations(filterCalculationsFrontend((document.getElementById('calcSearch') || {}).value || ''));
            } catch (e) {
                alert(e && e.message ? e.message : 'Errore');
            }
        }

        let pendingDeleteId = null;

        function openConfirmModal(id) {
            pendingDeleteId = id;
            const m = document.getElementById('confirmModal');
            if (m) m.classList.add('open');
        }

        function closeConfirmModal() {
            pendingDeleteId = null;
            const m = document.getElementById('confirmModal');
            if (m) m.classList.remove('open');
        }

        function confirmDeleteCalc(calcId) {
            openConfirmModal(calcId);
        }

        async function performDeleteCalc() {
            if (!pendingDeleteId) return;
            const id = pendingDeleteId;
            try {
                await apiRequest(`/api/v1/calculations/${id}`, { method: 'DELETE' });
                calculationsCache = calculationsCache.filter(c => c.id !== id);
                renderCalculations(filterCalculationsFrontend((document.getElementById('calcSearch') || {}).value || ''));
            } catch (e) {
                alert(e && e.message ? e.message : 'Errore');
            } finally {
                closeConfirmModal();
            }
        }

        async function loadAccount() {
            const token = localStorage.getItem('authToken');
            const user = parseJwt(token);
            if (!token || (!user.sub && !user.id && !user.email)) {
                localStorage.setItem('postLoginRedirect', '/dashboard');
                window.location.href = '/?login=1';
                return;
            }

            setAvatarDisplay({ nome: user.nome, cognome: user.cognome, email: user.email });

            try {
                const me = await apiRequest('/api/me', { method: 'GET' });
                const u = me.user || {};
                document.getElementById('accNome').value = u.nome || '';
                document.getElementById('accCognome').value = u.cognome || '';
                document.getElementById('accDataNascita').value = (u.data_nascita || '').slice(0, 10);
                document.getElementById('accProfessione').value = u.professione || 'commercialista';
                const studioNomeEl = document.getElementById('accStudioNome');
                if (studioNomeEl) studioNomeEl.value = u.studio_nome || '';
                const sedeIndirizzoEl = document.getElementById('accSedeIndirizzo');
                if (sedeIndirizzoEl) sedeIndirizzoEl.value = u.sede_indirizzo || '';
                const sedeCittaEl = document.getElementById('accSedeCitta');
                if (sedeCittaEl) sedeCittaEl.value = u.sede_citta || '';
                const sedeCapEl = document.getElementById('accSedeCap');
                if (sedeCapEl) sedeCapEl.value = u.sede_cap || '';
                const sedeProvinciaEl = document.getElementById('accSedeProvincia');
                if (sedeProvinciaEl) sedeProvinciaEl.value = u.sede_provincia || '';
                document.getElementById('accEmail').value = u.email || '';
                const badge = document.getElementById('accEmailBadge');
                if (badge) badge.style.display = u.email ? '' : 'none';
                setAvatarDisplay({ avatarUrl: u.avatar_url, nome: u.nome, cognome: u.cognome, email: u.email });
            } catch {
                document.getElementById('accEmail').value = user.email || '';
                setAvatarDisplay({ nome: user.nome, cognome: user.cognome, email: user.email });
            }
        }

        async function uploadAvatar(file) {
            const token = localStorage.getItem('authToken');
            if (!token) {
                alert('Devi effettuare il login.');
                return;
            }

            const form = new FormData();
            form.append('avatar', file);

            const res = await fetch('/api/me/avatar', {
                method: 'POST',
                headers: { Authorization: `Bearer ${token}` },
                body: form
            });

            if (!res.ok) {
                let data = null;
                try {
                    data = await res.json();
                } catch {
                    data = null;
                }
                const msg = data && data.error ? data.error : 'Upload non disponibile';
                throw new Error(msg);
            }

            const data = await res.json();
            return data;
        }

        async function downloadDocument(docId, type) {
            const token = localStorage.getItem('authToken');
            if (!token) {
                alert('Devi effettuare il login.');
                return;
            }

            try {
                const res = await fetch(`/api/documents/${docId}/download`, {
                    method: 'GET',
                    headers: {
                        Authorization: `Bearer ${token}`
                    }
                });

                if (!res.ok) {
                    let data = null;
                    try {
                        data = await res.json();
                    } catch {
                        data = null;
                    }
                    const msg = data && data.error ? data.error : 'Errore download';
                    throw new Error(msg);
                }

                const blob = await res.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${docId}.${type === 'pdf' ? 'pdf' : 'bin'}`;
                document.body.appendChild(a);
                a.click();
                a.remove();
                window.URL.revokeObjectURL(url);
            } catch (e) {
                alert(e && e.message ? e.message : 'Errore');
            }
        }

        async function saveAccount() {
            const nome = document.getElementById('accNome').value;
            const cognome = document.getElementById('accCognome').value;
            const dataNascita = document.getElementById('accDataNascita').value;
            const professione = document.getElementById('accProfessione').value;
            const studioNome = (document.getElementById('accStudioNome') || {}).value;
            const sedeIndirizzo = (document.getElementById('accSedeIndirizzo') || {}).value;
            const sedeCitta = (document.getElementById('accSedeCitta') || {}).value;
            const sedeCap = (document.getElementById('accSedeCap') || {}).value;
            const sedeProvincia = (document.getElementById('accSedeProvincia') || {}).value;

            if (!nome || !cognome || !dataNascita || !professione) {
                alert('Compila tutti i campi.');
                return;
            }

            try {
                const data = await apiRequest('/api/me', {
                    method: 'PUT',
                    body: JSON.stringify({ nome, cognome, dataNascita, professione, studioNome, sedeIndirizzo, sedeCitta, sedeCap, sedeProvincia })
                });
                if (data && data.token) {
                    localStorage.setItem('authToken', data.token);
                }
                updateHeaderUser();
                showToast('Modifiche salvate');
            } catch (e) {
                alert(e.message || 'Errore');
            }
        }

        (function() {
            updateHeaderUser();
            const params = new URLSearchParams(window.location.search);
            const view = params.get('view') || 'profile';
            setActiveView(view);

            const menuToggle = document.getElementById('accountMenuToggle');
            const backdrop = document.getElementById('accountSidebarBackdrop');
            if (menuToggle) {
                menuToggle.addEventListener('click', () => {
                    const sidebar = document.querySelector('.account-sidebar');
                    const isOpen = !!(sidebar && sidebar.classList.contains('is-open'));
                    setAccountMenuOpen(!isOpen);
                });
            }
            if (backdrop) {
                backdrop.addEventListener('click', () => setAccountMenuOpen(false));
            }

            document.querySelectorAll('.account-nav-item').forEach(btn => {
                if (!btn.matches('[data-view]')) return;
                btn.addEventListener('click', () => setActiveView(btn.getAttribute('data-view')));
            });

            const search = document.getElementById('calcSearch');
            if (search) {
                search.addEventListener('input', () => {
                    const q = search.value || '';
                    renderCalculations(filterCalculationsFrontend(q));
                    if (searchDebounce) window.clearTimeout(searchDebounce);
                    searchDebounce = window.setTimeout(() => {
                        if (document.getElementById('view-calculations') && document.getElementById('view-calculations').style.display !== 'none') {
                            loadCalculations(q);
                        }
                    }, 350);
                });
            }

            loadAccount();

            const avatarInput = document.getElementById('avatarInput');
            if (avatarInput) {
                avatarInput.addEventListener('change', async () => {
                    const file = avatarInput.files && avatarInput.files[0] ? avatarInput.files[0] : null;
                    if (!file) return;

                    const allowed = ['image/jpeg', 'image/png', 'image/webp'];
                    if (!allowed.includes(file.type)) {
                        alert('Formato non supportato. Usa JPG, PNG o WEBP.');
                        avatarInput.value = '';
                        return;
                    }
                    if (file.size > 2 * 1024 * 1024) {
                        alert('File troppo grande. Max 2MB.');
                        avatarInput.value = '';
                        return;
                    }

                    const previewUrl = URL.createObjectURL(file);
                    const img = document.getElementById('avatarImg');
                    const initials = document.getElementById('avatarInitials');
                    if (img && initials) {
                        img.src = previewUrl;
                        img.style.display = '';
                        initials.style.display = 'none';
                    }

                    try {
                        const out = await uploadAvatar(file);
                        if (out && out.user) {
                            setAvatarDisplay({ avatarUrl: out.user.avatar_url, nome: out.user.nome, cognome: out.user.cognome, email: out.user.email });
                        }
                        if (out && out.token) {
                            localStorage.setItem('authToken', out.token);
                            updateHeaderUser();
                        }
                        showToast('Foto profilo aggiornata');
                    } catch (e) {
                        alert(e && e.message ? e.message : 'Errore');
                    } finally {
                        avatarInput.value = '';
                        URL.revokeObjectURL(previewUrl);
                    }
                });
            }
        })();
    </script>

    <div id="confirmModal" class="account-modal-backdrop" role="dialog" aria-modal="true" aria-label="Conferma eliminazione" onclick="if(event.target.id==='confirmModal'){closeConfirmModal();}">
        <div class="account-modal">
            <div class="account-modal-title">Conferma</div>
            <div class="account-modal-body">Sei sicuro di voler eliminare questo calcolo?</div>
            <div class="account-modal-actions">
                <button class="account-link-btn" type="button" onclick="closeConfirmModal()">Annulla</button>
                <button class="account-danger-btn" type="button" onclick="performDeleteCalc()">Elimina</button>
            </div>
        </div>
    </div>

    <div id="toast" class="account-toast" role="status" aria-live="polite"></div>

    <script src="/mobileTopbar.js"></script>

</body>
</html>
