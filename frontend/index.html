<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="styles/styleIndex.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <title>equo compenso</title>
    </head>
<body>

    <header>

        <section class="header-img">
            <img src="img/logo2.png" alt="logo">
        </section>

        <div class="ls">
            <ul>
                <li><a href="index.html">home</a></li>
                <li><a href="chi-siamo.html">chi siamo</a></li>
                <li><a href="calcola.html">calcola</a></li>
                <li><a href="norme.html">norme</a></li>
                <li><button onclick="window.location.href='index.html?login=1'">login</button></li>
                <li><button onclick="openRegisterModal()">registrati</button></li>
            </ul>
        </div>

    </header>
    
    <main>

        <div class="cointener">
            <div class="hero">
                    <h1>Tutela il valore del tuo lavoro professionale</h1>
                    <p>Genera documenti, verifica i tuoi compensi e applica la Legge 49/2023 con strumenti pronti all'uso.</p>
                    <button class="inizia"><a href="login.html">Inizia ora gratis</a></button>
                    <button class="scopri"><a href="https://www.gazzettaufficiale.it/atto/vediMenuHTML?atto.dataPubblicazioneGazzetta=2023-05-05&atto.codiceRedazionale=23G00051&tipoSerie=serie_generale&tipoVigenza=originario">Scopri la normativa</a></button>
            </div>

            <div class="hero-img">
                <img src="img/uomini.png" alt="">
            </div>

        </div>

        <div class="section-divider"></div>

        <div class="card-container-wrapper">
            <button class="carousel-nav prev" onclick="scrollCards(-1)">‹</button>
            <button class="carousel-nav next" onclick="scrollCards(1)">›</button>
            
            <h2 class="card-container-slogan">I Nostri Servizi</h2>
            
            <div class="card-container">

                <div class="card">
                    <div class="card-content">
                        <h3>amministrazione e custodia</h3>
                        <div class="divider"></div>
                        <p>Controlla rapidamente se il compenso offerto dai grandi committenti rispetta i parametri minimi stabiliti dai decreti ministeriali vigenti. Un check essenziale per ogni preventivo.</p>
                        <a href="calcola.html" class="card-link">Scopri di più →</a>
                    </div>
                </div>

                <div class="card">
                    <div class="card-content">
                        <h3>assistenza in procedure concorsuali</h3>
                        <div class="divider"></div>
                        <p>Controlla rapidamente se il compenso offerto dai grandi committenti rispetta i parametri minimi stabiliti dai decreti ministeriali vigenti. Un check essenziale per ogni preventivo.</p>
                        <a href="calcola.html" class="card-link">Scopri di più →</a>
                    </div>
                </div>

                <div class="card">
                    <div class="card-content">
                        <h3>Collegio Sindacale</h3>
                        <div class="divider"></div>
                        <p>Controlla rapidamente se il compenso offerto dai grandi committenti rispetta i parametri minimi stabiliti dai decreti ministeriali vigenti. Un check essenziale per ogni preventivo.</p>
                        <a href="calcola.html" class="card-link">Scopri di più →</a>
                    </div>
                </div>

                <div class="card">
                    <div class="card-content">
                        <h3>consulenza finanziaria</h3>
                        <div class="divider"></div>
                        <p>Controlla rapidamente se il compenso offerto dai grandi committenti rispetta i parametri minimi stabiliti dai decreti ministeriali vigenti. Un check essenziale per ogni preventivo.</p>
                        <a href="calcola.html" class="card-link">Scopri di più →</a>
                    </div>
                </div>

                <div class="card">
                    <div class="card-content">
                        <h3>consulenza tributaria</h3>
                        <div class="divider"></div>
                        <p>Controlla rapidamente se il compenso offerto dai grandi committenti rispetta i parametri minimi stabiliti dai decreti ministeriali vigenti. Un check essenziale per ogni preventivo.</p>
                        <a href="calcola.html" class="card-link">Scopri di più →</a>
                    </div>
                </div>

                <div class="card">
                    <div class="card-content">
                        <h3>consulenza contrattuale</h3>
                        <div class="divider"></div>
                        <p>Controlla rapidamente se il compenso offerto dai grandi committenti rispetta i parametri minimi stabiliti dai decreti ministeriali vigenti. Un check essenziale per ogni preventivo.</p>
                        <a href="calcola.html" class="card-link">Scopri di più →</a>
                    </div>
                </div>

            </div>
        </div>

        <div class="section-divider"></div>

        <!-- Login Modal -->
        <div id="loginModal" class="login-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Login</h2>
                    <button class="close-modal" onclick="closeLoginModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <div id="loginError" class="login-error"></div>
                    <form class="login-form" onsubmit="handleLogin(event)">
                        <div class="form-group">
                            <label for="email">Email</label>
                            <input type="email" id="email" name="email" required autocomplete="email" placeholder="nome@dominio.it" inputmode="email">
                        </div>
                        <div class="form-group">
                            <label for="password">Password</label>
                            <input type="password" id="password" name="password" required autocomplete="current-password" placeholder="Minimo 6 caratteri">
                        </div>
                        <button type="submit" class="login-btn">Accedi</button>
                    </form>
                    <div class="register-link">
                        <p>Non hai un account? <a href="#" onclick="openRegisterModal()">Registrati</a></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Register Modal -->
        <div id="registerModal" class="login-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Registrati</h2>
                    <button class="close-modal" onclick="closeRegisterModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <div id="registerError" class="login-error"></div>
                    <form class="login-form" onsubmit="handleRegister(event)">
                        <div class="form-group">
                            <label for="regNome">Nome</label>
                            <input type="text" id="regNome" name="regNome" required autocomplete="given-name" placeholder="Mario">
                        </div>
                        <div class="form-group">
                            <label for="regCognome">Cognome</label>
                            <input type="text" id="regCognome" name="regCognome" required autocomplete="family-name" placeholder="Rossi">
                        </div>
                        <div class="form-group">
                            <label for="regDataNascita">Data di nascita</label>
                            <input type="date" id="regDataNascita" name="regDataNascita" required autocomplete="bday">
                        </div>
                        <div class="form-group">
                            <label for="regProfessione">Professione</label>
                            <select id="regProfessione" name="regProfessione" required>
                                <option value="" disabled selected>Seleziona</option>
                                <option value="commercialista">Commercialista</option>
                                <option value="avvocato">Avvocato</option>
                                <option value="ingegnere">Ingegnere</option>
                                <option value="architetto">Architetto</option>
                                <option value="geometra">Geometra</option>
                                <option value="perito">Perito industriale</option>
                                <option value="ragioniere">Ragioniere</option>
                                <option value="consulente_lavoro">Consulente del lavoro</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="regEmail">Email</label>
                            <input type="email" id="regEmail" name="regEmail" required autocomplete="email" placeholder="nome@dominio.it" inputmode="email">
                        </div>
                        <div class="form-group">
                            <label for="regPassword">Password</label>
                            <input type="password" id="regPassword" name="regPassword" required autocomplete="new-password" placeholder="Minimo 6 caratteri">
                        </div>
                        <div class="form-group">
                            <label for="regPasswordConfirm">Conferma Password</label>
                            <input type="password" id="regPasswordConfirm" name="regPasswordConfirm" required autocomplete="new-password" placeholder="Ripeti la password">
                        </div>
                        <button type="submit" class="login-btn">Registrati</button>
                    </form>
                    <div class="register-link">
                        <p>Hai già un account? <a href="#" onclick="openLoginModal()">Accedi</a></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Profile Modal -->
        <div id="profileModal" class="login-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Profilo</h2>
                    <button class="close-modal" onclick="closeProfileModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <div id="profileError" class="login-error"></div>
                    <form class="login-form" onsubmit="handleProfile(event)">
                        <div class="form-group">
                            <label for="profNome">Nome</label>
                            <input type="text" id="profNome" name="profNome" required>
                        </div>
                        <div class="form-group">
                            <label for="profCognome">Cognome</label>
                            <input type="text" id="profCognome" name="profCognome" required>
                        </div>
                        <div class="form-group">
                            <label for="profDataNascita">Data di nascita</label>
                            <input type="date" id="profDataNascita" name="profDataNascita" required>
                        </div>
                        <div class="form-group">
                            <label for="profProfessione">Professione</label>
                            <select id="profProfessione" name="profProfessione" required>
                                <option value="commercialista">Commercialista</option>
                                <option value="avvocato">Avvocato</option>
                                <option value="ingegnere">Ingegnere</option>
                                <option value="architetto">Architetto</option>
                                <option value="geometra">Geometra</option>
                                <option value="perito">Perito industriale</option>
                                <option value="ragioniere">Ragioniere</option>
                                <option value="consulente_lavoro">Consulente del lavoro</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="profEmail">Email</label>
                            <input type="email" id="profEmail" name="profEmail" required readonly>
                        </div>
                        <button type="submit" class="login-btn">Salva modifiche</button>
                    </form>
                </div>
            </div>
        </div>

        <div class="contattaci">
            <h2>contattaci</h2>
            <div class="contact-content">
                
                <div class="cont-form">
                    <form class="contact-form">
                        <input type="text" placeholder="Nome" required>
                        <select required>
                            <option value="" disabled selected>Servizio</option>
                            <option value="amministrazione">Amministrazione e custodia</option>
                            <option value="procedure">Assistenza in procedure concorsuali</option>
                            <option value="collegio">Collegio Sindacale</option>
                            <option value="finanziaria">Consulenza finanziaria</option>
                            <option value="tributaria">Consulenza tributaria</option>
                            <option value="contrattuale">Consulenza contrattuale</option>
                        </select>
                        <input type="email" placeholder="Email" required>
                        <input type="tel" placeholder="Telefono" required>
                        <button type="submit">Invia →</button>
                    </form>
                </div>
                
                <div class="contact-info">
                    <div class="info-item">
                        <span class="icon"><i class="far fa-clock"></i></span>
                        <p>Lun-Ven 10.00am - 6.00p.m</p>
                    </div>
                    <div class="info-item">
                        <span class="icon"><i class="fas fa-phone"></i></span>
                        <p>+39 0942 550660</p>
                    </div>
                    <div class="info-item">
                        <span class="icon"><i class="far fa-envelope"></i></span>
                        <p>info@equocompenso.eu</p>
                    </div>
                </div>
            </div>
        </div>

    </main>
    
    <footer>
        <div class="footer-content">
            <p>&copy; 2025 equocompenso. All rights reserved.</p>
        </div>
    </footer>

    <script>
        function scrollCards(direction) {
            const container = document.querySelector('.card-container');
            const cardWidth = 380; // 350px + 30px gap
            const currentScroll = container.scrollLeft;
            const newScroll = currentScroll + (cardWidth * direction);
            
            container.scrollTo({
                left: newScroll,
                behavior: 'smooth'
            });
        }

        // Login Modal Functions
        function openLoginModal() {
            document.getElementById('loginModal').style.display = 'flex';
            hideLoginError();
        }

        function closeLoginModal() {
            document.getElementById('loginModal').style.display = 'none';
            hideLoginError();
        }

        function showLoginError(message) {
            const el = document.getElementById('loginError');
            if (!el) return;
            el.textContent = message;
            el.style.display = 'block';
        }

        function hideLoginError() {
            const el = document.getElementById('loginError');
            if (!el) return;
            el.textContent = '';
            el.style.display = 'none';
        }

        function parseJwt(token) {
            if (!token || typeof token !== 'string') return {};
            const parts = token.split('.');
            if (parts.length !== 3) return {};
            try {
                return JSON.parse(atob(parts[1].replace(/-/g, '+').replace(/_/g, '/')));
            } catch {
                return {};
            }
        }

        async function apiRequest(path, options = {}) {
            const token = localStorage.getItem('authToken');
            const headers = Object.assign({ 'Content-Type': 'application/json' }, options.headers || {});
            if (token) headers.Authorization = `Bearer ${token}`;

            const res = await fetch(path, Object.assign({}, options, { headers }));
            let data = null;
            try {
                data = await res.json();
            } catch {
                data = null;
            }
            if (!res.ok) {
                const msg = data && data.error ? data.error : 'Errore server';
                throw new Error(msg);
            }
            return data;
        }

        function updateHeaderUser() {
            const token = localStorage.getItem('authToken');
            const user = parseJwt(token);
            const headerUl = document.querySelector('.ls ul');
            if (!headerUl) return;
            const isLogged = !!token && (!!user.sub || !!user.id || !!user.email);

            function isAuthLi(li) {
                const txt = (li.textContent || '').trim().toLowerCase();
                if (txt === 'login' || txt === 'registrati') return true;
                const btn = li.querySelector('button');
                if (btn && btn.onclick) {
                    const fn = btn.onclick.toString();
                    if (fn.includes('login') || fn.includes('openRegisterModal') || fn.includes('register')) return true;
                }
                const a = li.querySelector('a');
                if (a) {
                    const href = (a.getAttribute('href') || '').toLowerCase();
                    if (href.includes('login') || href.includes('register')) return true;
                }
                return false;
            }

            if (isLogged) {
                headerUl.querySelectorAll('li').forEach(li => {
                    if (isAuthLi(li)) li.style.display = 'none';
                });
                if (!headerUl.querySelector('.user-item')) {
                    const userLi = document.createElement('li');
                    userLi.className = 'user-item';
                    userLi.innerHTML = `
                        <div class="user-dropdown">
                            <button class="user-btn" onclick="toggleUserDropdown()">
                                <span class="user-avatar"><i class="fas fa-user"></i></span>
                                <span class="user-welcome-text">Ciao, ${user.nome || user.email || ''}</span>
                            </button>
                            <div id="userDropdownMenu" class="user-dropdown-menu" style="display:none;">
                                <button onclick="openProfileModal()">Profilo</button>
                                <button onclick="handleLogout()">Logout</button>
                            </div>
                        </div>
                    `;
                    headerUl.appendChild(userLi);
                }
            } else {
                headerUl.querySelectorAll('li').forEach(li => {
                    if (isAuthLi(li)) li.style.display = '';
                });
                const userLi = headerUl.querySelector('.user-item');
                if (userLi) userLi.remove();
            }
        }

        function toggleUserDropdown() {
            const menu = document.getElementById('userDropdownMenu');
            if (menu) menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
        }

        function handleLogout() {
            localStorage.removeItem('authToken');
            updateHeaderUser();
            window.location.href = 'index.html';
        }

        function openProfileModal() {
            const token = localStorage.getItem('authToken');
            const user = parseJwt(token);
            if (!user.sub) {
                alert('Utente non loggato.');
                return;
            }

            (async () => {
                try {
                    const me = await apiRequest('/api/me', { method: 'GET' });
                    const u = me.user;
                    document.getElementById('profNome').value = u.nome || '';
                    document.getElementById('profCognome').value = u.cognome || '';
                    document.getElementById('profDataNascita').value = (u.data_nascita || '').slice(0, 10);
                    document.getElementById('profProfessione').value = u.professione || '';
                    document.getElementById('profEmail').value = u.email || '';

                    document.getElementById('profileModal').style.display = 'flex';
                    hideProfileError();
                } catch (e) {
                    alert(e.message || 'Errore');
                }
            })();
        }

        function closeProfileModal() {
            document.getElementById('profileModal').style.display = 'none';
            hideProfileError();
        }

        function showProfileError(message) {
            const el = document.getElementById('profileError');
            if (!el) return;
            el.textContent = message;
            el.style.display = 'block';
        }

        function hideProfileError() {
            const el = document.getElementById('profileError');
            if (!el) return;
            el.textContent = '';
            el.style.display = 'none';
        }

        function handleProfile(event) {
            event.preventDefault();
            const token = localStorage.getItem('authToken');
            const user = parseJwt(token);
            if (!user.sub) {
                showProfileError('Utente non loggato.');
                return;
            }

            const nome = document.getElementById('profNome').value;
            const cognome = document.getElementById('profCognome').value;
            const dataNascita = document.getElementById('profDataNascita').value;
            const professione = document.getElementById('profProfessione').value;
            const email = document.getElementById('profEmail').value;

            if (!nome || !cognome || !dataNascita || !professione || !email) {
                showProfileError('Compila tutti i campi.');
                return;
            }

            if (!email.includes('@')) {
                showProfileError('Email non valida.');
                return;
            }

            (async () => {
                try {
                    // MVP: aggiorniamo solo i campi editabili. L'email resta visibile ma non la cambiamo lato server.
                    const data = await apiRequest('/api/me', {
                        method: 'PUT',
                        body: JSON.stringify({ nome, cognome, dataNascita, professione })
                    });

                    if (data && data.token) {
                        localStorage.setItem('authToken', data.token);
                    }
                    updateHeaderUser();
                    closeProfileModal();
                } catch (e) {
                    showProfileError(e.message || 'Errore');
                }
            })();
        }

        // Chiudi modale profilo se si clicca fuori
        window.onclick = function(event) {
            const loginModal = document.getElementById('loginModal');
            const registerModal = document.getElementById('registerModal');
            const profileModal = document.getElementById('profileModal');
            if (event.target === loginModal) {
                closeLoginModal();
            }
            if (event.target === registerModal) {
                closeRegisterModal();
            }
            if (event.target === profileModal) {
                closeProfileModal();
            }
        }

        function handleLogin(event) {
            event.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            if (!email || !password) {
                showLoginError('Inserisci email e password.');
                return;
            }

            if (!email.includes('@') || password.length < 6) {
                showLoginError('Credenziali non valide.');
                return;
            }

            (async () => {
                try {
                    const data = await apiRequest('/api/auth/login', {
                        method: 'POST',
                        body: JSON.stringify({ email, password })
                    });
                    localStorage.setItem('authToken', data.token);
                    updateHeaderUser();
                    const redirectTo = localStorage.getItem('postLoginRedirect') || 'calcola.html';
                    localStorage.removeItem('postLoginRedirect');
                    window.location.href = redirectTo;
                } catch (e) {
                    showLoginError(e.message || 'Errore');
                }
            })();
        }

        // Register Modal Functions
        function openRegisterModal() {
            closeLoginModal();
            document.getElementById('registerModal').style.display = 'flex';
            hideRegisterError();
        }

        function closeRegisterModal() {
            document.getElementById('registerModal').style.display = 'none';
            hideRegisterError();
        }

        function showRegisterError(message) {
            const el = document.getElementById('registerError');
            if (!el) return;
            el.textContent = message;
            el.style.display = 'block';
        }

        function hideRegisterError() {
            const el = document.getElementById('registerError');
            if (!el) return;
            el.textContent = '';
            el.style.display = 'none';
        }

        function handleRegister(event) {
            event.preventDefault();
            const nome = document.getElementById('regNome').value;
            const cognome = document.getElementById('regCognome').value;
            const dataNascita = document.getElementById('regDataNascita').value;
            const professione = document.getElementById('regProfessione').value;
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPassword').value;
            const passwordConfirm = document.getElementById('regPasswordConfirm').value;

            if (!nome || !cognome || !dataNascita || !professione || !email || !password || !passwordConfirm) {
                showRegisterError('Compila tutti i campi.');
                return;
            }

            if (!email.includes('@')) {
                showRegisterError('Email non valida.');
                return;
            }

            if (password.length < 6) {
                showRegisterError('La password deve essere di almeno 6 caratteri.');
                return;
            }

            if (password !== passwordConfirm) {
                showRegisterError('Le password non coincidono.');
                return;
            }

            (async () => {
                try {
                    const data = await apiRequest('/api/auth/register', {
                        method: 'POST',
                        body: JSON.stringify({ email, password, nome, cognome, dataNascita, professione })
                    });
                    localStorage.setItem('authToken', data.token);
                    updateHeaderUser();
                    const redirectTo = localStorage.getItem('postLoginRedirect') || 'calcola.html';
                    localStorage.removeItem('postLoginRedirect');
                    window.location.href = redirectTo;
                } catch (e) {
                    showRegisterError(e.message || 'Errore');
                }
            })();
        }

        // Chiudi dropdown se si clicca fuori
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.user-dropdown')) {
                const menu = document.getElementById('userDropdownMenu');
                if (menu) menu.style.display = 'none';
            }
        });

        (function() {
            const params = new URLSearchParams(window.location.search);
            if (params.get('login') === '1') {
                openLoginModal();
            }
            if (params.get('register') === '1') {
                openRegisterModal();
            }
            if (params.get('profile') === '1') {
                openProfileModal();
            }
            updateHeaderUser();
        })();
    </script>

</body>
</html>