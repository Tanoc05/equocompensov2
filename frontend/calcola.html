<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="styles/styleIndex.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <title>Calcola - equo compenso</title>
</head>
<body>

    <header>
        <section class="header-img">
            <img src="img/logo2.png" alt="logo">
        </section>

        <div class="ls">
            <ul>
                <li><a href="index.html">home</a></li>
                <li><a href="chi-siamo.html">chi siamo</a></li>
                <li><a href="calcola.html">calcola</a></li>
                <li><a href="norme.html">norme</a></li>
                <li><button onclick="window.location.href='index.html?login=1'">login</button></li>
                <li><button onclick="openRegisterModal()">registrati</button></li>
            </ul>
        </div>

    </header>
    
    <main>

        <div class="container">
            <div class="dashboard-top">
                <div id="welcomeUser" class="dashboard-welcome">Benvenuto</div>
                <button class="dashboard-logout" type="button" onclick="handleLogout()">logout</button>
            </div>

            <div class="dashboard-layout">
                <aside class="dashboard-sidebar">
                    <button class="dashboard-nav-btn is-active" type="button">Crea documento</button>
                    <button class="dashboard-nav-btn" type="button" onclick="window.location.href='index.html?profile=1'">Modifica dati</button>
                    <button class="dashboard-nav-btn" type="button" onclick="alert('Sezione in arrivo');">Documenti prodotti</button>
                </aside>

                <section class="dashboard-card" aria-label="Crea documento">
                    <div class="dashboard-card-inner">
                        <div class="form-group">
                            <label for="documentType">Nome del documento <span aria-hidden="true" style="color:#b00020">*</span></label>
                            <select id="documentType" name="documentType" required>
                                <option value="" disabled selected>Seleziona</option>
                                <option value="amministrazione_custodia">Amministrazione e custodia</option>
                                <option value="procedure_concorsuali">Assistenza in procedure concorsuali</option>
                                <option value="consulente_finanziamento">Consulente finanziamento</option>
                                <option value="consulente_economico_finanziaria">Consulente economico-finanziaria</option>
                                <option value="consulenza_contrattuale">Consulenza contrattuale</option>
                                <option value="consulenza_tributaria">Consulenza tributaria</option>
                                <option value="contabilita_ordinaria">Contabilità ordinaria</option>
                                <option value="contabilita_semplicata">Contabilità semplificata</option>
                                <option value="dichiarazione">Dichiarazione</option>
                                <option value="perizie_valutazioni">Perizie e valutazioni</option>
                                <option value="formazione_bilancio">Formazione del Bilancio</option>
                                <option value="liquidazione">Liquidazione</option>
                                <option value="operazioni_societarie_1">Operazioni societarie 1</option>
                                <option value="operazioni_societarie_2">Operazioni societarie 2</option>
                                <option value="consulenza_finanziamenti">Consulenza su finanziamenti</option>
                                <option value="revisioni_contabili">Revisioni Contabili</option>
                                <option value="rappresentanza_tributaria">Rappresentanza Tributaria</option>
                            </select>
                        </div>

                        <div class="form-group" id="groupCategory">
                            <label for="documentCategory">Categoria / Prestazione</label>
                            <select id="documentCategory" name="documentCategory">
                                <option value="" selected>Seleziona</option>
                            </select>
                        </div>

                        <div class="form-group" id="groupPattuito">
                            <label for="corrispettivoPattuito">Corrispettivo pattuito (€)</label>
                            <input id="corrispettivoPattuito" name="corrispettivoPattuito" type="number" min="0" step="0.01" placeholder="0,00">
                        </div>

                        <div class="form-group" id="groupPercentuale">
                            <label for="percentuale">Percentuale (%)</label>
                            <input id="percentuale" name="percentuale" type="number" min="0" max="100" step="0.01" placeholder="0,00">
                        </div>

                        <div class="dashboard-grid">
                            <div>
                                <form id="calcForm" class="dashboard-form">
                                    <input type="hidden" id="professione" name="professione" value="commercialista">
                                    <input type="hidden" id="prestazione" name="prestazione" value="">

                                    <div class="form-group">
                                        <label for="criterio">Criterio calcolo</label>
                                        <select id="criterio" name="criterio" required>
                                            <option value="min">Minimo</option>
                                            <option value="medio" selected>Medio</option>
                                            <option value="max">Massimo</option>
                                        </select>
                                    </div>

                                    <div class="form-group" id="groupConteggiare">
                                        <label for="conteggiare">Conteggiare?</label>
                                        <select id="conteggiare" name="conteggiare">
                                            <option value="no" selected>No</option>
                                            <option value="si">Sì</option>
                                        </select>
                                    </div>

                                    <div class="form-group">
                                        <label id="labelValore" for="valore">Valore</label>
                                        <input id="valore" name="valore" type="number" min="0" step="0.01" placeholder="0,00" required>
                                    </div>

                                    <div class="form-group">
                                        <label id="labelValore2" for="valore2">Secondo valore</label>
                                        <input id="valore2" name="valore2" type="number" min="0" step="0.01" placeholder="0,00">
                                    </div>

                                    <div class="form-group">
                                        <label id="labelValore3" for="valore3">Terzo valore</label>
                                        <input id="valore3" name="valore3" type="number" min="0" step="0.01" placeholder="0,00">
                                    </div>

                                    <div class="form-group">
                                        <label for="dichiarazione">Dichiarazione (solo sezione "Dichiarazione")</label>
                                        <select id="dichiarazione" name="dichiarazione">
                                            <option value="" selected>N/A</option>
                                            <option value="pf">Dichiarazione redditi persone fisiche</option>
                                            <option value="pf_piva">Dichiarazione redditi PF con partita IVA</option>
                                            <option value="sp">Dichiarazione redditi società di persone</option>
                                            <option value="sc">Dichiarazione redditi società di capitali</option>
                                            <option value="irap">Dichiarazione IRAP</option>
                                            <option value="iva">Dichiarazione IVA</option>
                                            <option value="770">Dichiarazione sostituti d'imposta</option>
                                            <option value="invio">Invio telematico</option>
                                            <option value="successione">Dichiarazione di successione</option>
                                            <option value="altre">Altre dichiarazioni e comunicazioni</option>
                                        </select>
                                    </div>

                                    <div class="form-group" id="groupEsitoNegativo">
                                        <label>Procedure concorsuali (solo sezione "Assistenza in procedure concorsuali")</label>
                                        <div>
                                            <input id="esitoNegativo" name="esitoNegativo" type="checkbox">
                                            <label for="esitoNegativo">Esito negativo (riduzione fino alla metà)</label>
                                        </div>
                                    </div>

                                    <div class="calcola-actions">
                                        <button id="btnCalcola" class="btn-primary" type="button">Calcola</button>
                                        <button id="btnDownloadPdf" class="btn-secondary" type="button" disabled>Scarica documento (PDF)</button>
                                        <button class="btn-secondary" type="reset">Reset</button>
                                    </div>

                                    <div id="calcolaResult" class="calcola-result">
                                        Risultato: in attesa di calcolo.
                                    </div>
                                </form>
                            </div>

                            <aside class="dashboard-preview" aria-label="Anteprima documento">
                                <div class="dashboard-preview-title">Anteprima documento</div>
                                <div id="documentPreview" class="dashboard-preview-body">
                                    Seleziona una sezione e inserisci i dati per vedere l'anteprima.
                                </div>
                            </aside>
                        </div>
                    </div>
                </section>
            </div>
        </div>

    </main>
    
    <footer>
        <div class="footer-content">
            <p>&copy; 2025 equocompenso. All rights reserved.</p>
        </div>
    </footer>

    <script>
        (function() {
            const token = localStorage.getItem('authToken');
            if (!token) {
                localStorage.setItem('postLoginRedirect', 'calcola.html');
                window.location.replace('index.html?login=1');
            }
        })();

        function openRegisterModal() {
            window.location.href = 'index.html?register=1';
        }

        (function() {
            const prestazioneEl = document.getElementById('prestazione');
            const documentTypeEl = document.getElementById('documentType');
            const documentCategoryEl = document.getElementById('documentCategory');
            const criterioEl = document.getElementById('criterio');
            const valoreEl = document.getElementById('valore');
            const valore2El = document.getElementById('valore2');
            const valore3El = document.getElementById('valore3');
            const dichiarazioneEl = document.getElementById('dichiarazione');
            const esitoNegativoEl = document.getElementById('esitoNegativo');
            const conteggiareEl = document.getElementById('conteggiare');
            const pattuitoEl = document.getElementById('corrispettivoPattuito');
            const percentualeEl = document.getElementById('percentuale');
            const groupCategory = document.getElementById('groupCategory');
            const groupPattuito = document.getElementById('groupPattuito');
            const groupPercentuale = document.getElementById('groupPercentuale');
            const groupConteggiare = document.getElementById('groupConteggiare');
            const groupEsitoNegativo = document.getElementById('groupEsitoNegativo');
            const btn = document.getElementById('btnCalcola');
            const btnDownloadPdf = document.getElementById('btnDownloadPdf');
            const resultEl = document.getElementById('calcolaResult');
            const professioneEl = document.getElementById('professione');
            const previewEl = document.getElementById('documentPreview');
            const welcomeEl = document.getElementById('welcomeUser');

            const labelValore = document.getElementById('labelValore');
            const labelValore2 = document.getElementById('labelValore2');
            const labelValore3 = document.getElementById('labelValore3');

            let sumModeR1 = false;

            function setPreview(html) {
                if (!previewEl) return;
                previewEl.innerHTML = html;
            }

            function setBlockVisible(el, visible) {
                if (!el) return;
                el.style.display = visible ? '' : 'none';
            }

            function setInputGroupVisible(inputEl, visible) {
                if (!inputEl) return;
                const group = inputEl.closest('.form-group');
                if (!group) return;
                group.style.display = visible ? '' : 'none';
            }

            function updateWelcome() {
                const token = localStorage.getItem('authToken');
                const user = parseJwt(token);
                if (welcomeEl) {
                    welcomeEl.textContent = `Benvenuto, ${user.nome || user.email || ''}`;
                }
            }

            const docConfig = {
                amministrazione_custodia: {
                    riquadro: 'r1',
                    sumR1: true,
                    labels: {
                        v1: 'Componenti positivi di redditi lordi (€)',
                        v2: 'Totale attività (€)',
                    },
                    show: { v2: true, v3: false, dichiarazione: false, esitoNegativo: false, conteggiare: false },
                    showPattuito: true,
                    showPercentuale: true,
                },
                contabilita_ordinaria: {
                    riquadro: 'r4',
                    sumR1: false,
                    labels: {
                        v1: 'a) CORRISPETTIVO PATTUITO (€)',
                        v2: 'b) TOTALE ATTIVITA\' (€)',
                        v3: 'c) AMMONTARE DELLE PASSIVITA\' (€)',
                    },
                    show: { v2: true, v3: true, dichiarazione: false, esitoNegativo: false, conteggiare: false },
                    showPattuito: false,
                    showPercentuale: true,
                },
                contabilita_semplicata: {
                    riquadro: 'r1',
                    sumR1: false,
                    labels: {
                        v1: 'a) CORRISPETTIVO PATTUITO (€)',
                    },
                    show: { v2: false, v3: false, dichiarazione: false, esitoNegativo: false, conteggiare: false },
                    showPattuito: false,
                    showPercentuale: true,
                },
                formazione_bilancio: {
                    riquadro: 'r4',
                    sumR1: false,
                    labels: {
                        v1: 'TOTALE COMPONENTI POSITIVI DI REDDITO LORDI (€)',
                        v2: 'TOTALE DELLE ATTIVITA\' (€)',
                        v3: 'AMMONTARE DELLE PASSIVITA\' (€)',
                    },
                    show: { v2: true, v3: true, dichiarazione: false, esitoNegativo: false, conteggiare: false },
                    showPattuito: true,
                    showPercentuale: true,
                },
                procedure_concorsuali: {
                    riquadro: 'r9',
                    sumR1: false,
                    labels: { v1: 'Totale delle passività (€)' },
                    show: { v2: false, v3: false, dichiarazione: false, esitoNegativo: true, conteggiare: true },
                    showPattuito: true,
                    showPercentuale: true,
                },
                consulente_finanziamento: {
                    riquadro: 'r8_2',
                    sumR1: false,
                    labels: { v1: 'Capitale mutuato/finanziato (€)' },
                    show: { v2: false, v3: false, dichiarazione: false, esitoNegativo: false, conteggiare: false },
                    showPattuito: true,
                    showPercentuale: true,
                },
                consulente_economico_finanziaria: {
                    riquadro: 'r8_2',
                    sumR1: false,
                    labels: { v1: 'Capitali/valori econ-finanziari (€)' },
                    show: { v2: false, v3: false, dichiarazione: false, esitoNegativo: false, conteggiare: false },
                    showPattuito: true,
                    showPercentuale: true,
                },
                dichiarazione: {
                    riquadro: 'r10_1',
                    sumR1: false,
                    labels: { },
                    show: { v2: false, v3: false, dichiarazione: true, esitoNegativo: false, conteggiare: false },
                    showPattuito: true,
                    showPercentuale: true,
                },
                perizie_valutazioni: {
                    riquadro: 'r3',
                    sumR1: false,
                    labels: { v1: 'Valore perizia / valutazione (€)' },
                    show: { v2: false, v3: false, dichiarazione: false, esitoNegativo: false, conteggiare: false },
                    showPattuito: true,
                    showPercentuale: true,
                },
                default: {
                    riquadro: 'r1',
                    sumR1: false,
                    labels: { v1: 'Valore di riferimento (€)' },
                    show: { v2: false, v3: false, dichiarazione: false, esitoNegativo: false, conteggiare: false },
                    showPattuito: true,
                    showPercentuale: true,
                }
            };

            const docCategories = {
                amministrazione_custodia: [
                    { id: 'amm_custodia_base', label: 'Attività di amministrazione e custodia (base)', percent: 100 },
                    { id: 'amm_custodia_complessa', label: 'Attività complessa / urgenza', percent: 120 },
                ],
                procedure_concorsuali: [
                    { id: 'proc_assistenza', label: 'Assistenza in procedure concorsuali', percent: 100 },
                    { id: 'proc_esito_neg', label: 'Esito negativo (riduzione)', percent: 50 },
                ],
                dichiarazione: [
                    { id: 'dich_pf', label: 'Dichiarazione PF', percent: 100 },
                    { id: 'dich_sc', label: 'Dichiarazione Società di capitali', percent: 100 },
                ],
                perizie_valutazioni: [
                    { id: 'perizia', label: 'Perizia / Valutazione', percent: 100 },
                ],
            };

            function fillCategoryOptions() {
                if (!documentCategoryEl) return;
                const key = documentTypeEl ? documentTypeEl.value : '';
                const list = docCategories[key] || [];

                documentCategoryEl.innerHTML = '<option value="" selected>Seleziona</option>';
                for (const item of list) {
                    const opt = document.createElement('option');
                    opt.value = item.id;
                    opt.textContent = item.label;
                    opt.dataset.percent = String(item.percent);
                    documentCategoryEl.appendChild(opt);
                }

                setBlockVisible(groupCategory, list.length > 0);
            }

            function applyCategory() {
                if (!documentCategoryEl || !percentualeEl) return;
                const opt = documentCategoryEl.options[documentCategoryEl.selectedIndex];
                const p = opt && opt.dataset && opt.dataset.percent ? Number(opt.dataset.percent) : NaN;
                if (Number.isFinite(p)) {
                    percentualeEl.value = String(p);
                }
            }

            function applyDocType() {
                const key = documentTypeEl ? documentTypeEl.value : '';
                const cfg = docConfig[key] || docConfig.default;

                sumModeR1 = !!cfg.sumR1;
                if (prestazioneEl) prestazioneEl.value = cfg.riquadro;

                if (labelValore) labelValore.textContent = cfg.labels.v1 || 'Valore (€)';
                if (labelValore2) labelValore2.textContent = cfg.labels.v2 || 'Secondo valore (€)';
                if (labelValore3) labelValore3.textContent = cfg.labels.v3 || 'Terzo valore (€)';

                setInputGroupVisible(valore2El, !!cfg.show.v2);
                setInputGroupVisible(valore3El, !!cfg.show.v3);
                setInputGroupVisible(dichiarazioneEl, !!cfg.show.dichiarazione);
                setBlockVisible(groupEsitoNegativo, !!cfg.show.esitoNegativo);
                setBlockVisible(groupConteggiare, !!cfg.show.conteggiare);

                setBlockVisible(groupPattuito, cfg.showPattuito !== false);
                setBlockVisible(groupPercentuale, cfg.showPercentuale !== false);

                // required
                if (valoreEl) valoreEl.required = cfg.riquadro !== 'r10_1';
                if (valore2El) valore2El.required = !!cfg.show.v2;
                if (valore3El) valore3El.required = !!cfg.show.v3;

                // reset buttons/preview
                if (btnDownloadPdf) {
                    btnDownloadPdf.disabled = true;
                    btnDownloadPdf.dataset.payload = '';
                }
                setPreview('Seleziona una sezione e inserisci i dati per vedere l\'anteprima.');

                fillCategoryOptions();
                if (percentualeEl) percentualeEl.value = '';
                if (pattuitoEl) pattuitoEl.value = '';
            }

            function setEnabled(el, enabled) {
                if (!el) return;
                el.disabled = !enabled;
                if (!enabled) {
                    if (el.tagName === 'SELECT') el.value = '';
                    if (el.tagName === 'INPUT') {
                        if (el.type === 'checkbox') el.checked = false;
                        else el.value = '';
                    }
                }
            }

            function setGroupVisible(el, visible) {
                if (!el) return;
                const group = el.closest('.form-group');
                if (!group) return;
                group.style.display = visible ? '' : 'none';
            }

            function updateFieldVisibility() {
                const tipo = prestazioneEl ? prestazioneEl.value : '';

                // Manteniamo la logica originale per i riquadri "puri" (fallback)
                // valore = principale. valore2 = secondario (quando serve). valore3 = terzo (quando serve). dichiarazione = solo Riquadro 10.1
                setEnabled(valoreEl, tipo !== 'r10_1');
                setEnabled(valore2El, ['r2', 'r4', 'r5_1', 'r6'].includes(tipo));
                setEnabled(valore3El, ['r4', 'r5_1', 'r6'].includes(tipo));
                setEnabled(dichiarazioneEl, tipo === 'r10_1');
                setEnabled(esitoNegativoEl, tipo === 'r9');

                if (tipo === 'r10_1') {
                    valoreEl.required = false;
                    valore2El.required = false;
                    valore3El.required = false;
                } else {
                    valoreEl.required = true;
                    valore2El.required = ['r2', 'r4', 'r5_1', 'r6'].includes(tipo);
                    valore3El.required = ['r4', 'r5_1', 'r6'].includes(tipo);
                }

                if (labelValore) labelValore.textContent = 'Valore di riferimento (€)';
                if (labelValore2) labelValore2.textContent = 'Secondo valore (€)';
                if (labelValore3) labelValore3.textContent = 'Terzo valore (€)';

                if (tipo === 'r2') {
                    if (labelValore) labelValore.textContent = 'Attivo realizzato (€)';
                    if (labelValore2) labelValore2.textContent = 'Passivo accertato (€)';
                }
                if (tipo === 'r4' || tipo === 'r5_1' || tipo === 'r6') {
                    if (labelValore) labelValore.textContent = 'Componenti positivi di reddito lordi (€)';
                    if (labelValore2) labelValore2.textContent = 'Totale attività (€)';
                    if (labelValore3) labelValore3.textContent = 'Ammontare passività (€)';
                }
                if (tipo === 'r3') {
                    if (labelValore) labelValore.textContent = 'Valore perizia / valutazione (€)';
                }
                if (tipo === 'r7_1') {
                    if (labelValore) labelValore.textContent = 'Capitale sottoscritto (€)';
                }
                if (tipo === 'r7_2') {
                    if (labelValore) labelValore.textContent = 'Totale attività (€)';
                }
                if (tipo === 'r8_1') {
                    if (labelValore) labelValore.textContent = 'Corrispettivo pattuito (€)';
                }
                if (tipo === 'r8_2') {
                    if (labelValore) labelValore.textContent = 'Capitale mutuato/erogato (€)';
                }
                if (tipo === 'r9') {
                    if (labelValore) labelValore.textContent = 'Totale passività (€)';
                }
                if (tipo === 'r10_2' || tipo === 'r10_3') {
                    if (labelValore) labelValore.textContent = 'Imposte/tasse/contributi/sanzioni/interessi dovuti (€)';
                }
                if (tipo === 'r11') {
                    if (labelValore) labelValore.textContent = 'Redditi + attività (somma) (€)';
                }
            }

            function pickRate(min, max, criterio) {
                if (criterio === 'min') return min;
                if (criterio === 'max') return max;
                return (min + max) / 2;
            }

            function rateRange(a, b) {
                const minRate = Math.min(a, b);
                const maxRate = Math.max(a, b);
                return { minRate, maxRate };
            }

            function tiered(value, tiers) {
                // tiers: [{ upto, minRate, maxRate }] with progressive application
                let remaining = value;
                let lastCap = 0;
                let minTotal = 0;
                let maxTotal = 0;

                for (const t of tiers) {
                    if (remaining <= 0) break;
                    const cap = t.upto;
                    const span = Math.max(0, Math.min(value, cap) - lastCap);
                    if (span > 0) {
                        minTotal += span * t.minRate;
                        maxTotal += span * t.maxRate;
                    }
                    lastCap = cap;
                }

                // last tier with upto: Infinity
                const last = tiers[tiers.length - 1];
                if (last && last.upto === Infinity) {
                    const span = Math.max(0, value - lastCap);
                    if (span > 0) {
                        minTotal += span * last.minRate;
                        maxTotal += span * last.maxRate;
                    }
                }

                return { minTotal, maxTotal };
            }

            function euro(n) {
                return new Intl.NumberFormat('it-IT', { style: 'currency', currency: 'EUR' }).format(n);
            }

            async function apiRequest(path, options = {}) {
                const token = localStorage.getItem('authToken');
                const headers = Object.assign({ 'Content-Type': 'application/json' }, options.headers || {});
                if (token) headers.Authorization = `Bearer ${token}`;

                const res = await fetch(path, Object.assign({}, options, { headers }));
                let data = null;
                try {
                    data = await res.json();
                } catch {
                    data = null;
                }
                if (!res.ok) {
                    const msg = data && data.error ? data.error : 'Errore server';
                    throw new Error(msg);
                }
                return data;
            }

            async function downloadDocumentPdf(documentId) {
                const token = localStorage.getItem('authToken');
                const res = await fetch(`/api/documents/${documentId}/download`, {
                    method: 'GET',
                    headers: { Authorization: `Bearer ${token}` }
                });

                if (!res.ok) {
                    let msg = 'Errore download';
                    try {
                        const data = await res.json();
                        if (data && data.error) msg = data.error;
                    } catch {}
                    throw new Error(msg);
                }

                const blob = await res.blob();
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `documento-compenso-${documentId}.pdf`;
                document.body.appendChild(a);
                a.click();
                a.remove();
                URL.revokeObjectURL(url);
            }

            function buildPayloadFromForm({ tipo, criterio, min, max, chosen, details }) {
                const input = {
                    documentType: documentTypeEl ? documentTypeEl.value : null,
                    documentCategory: documentCategoryEl ? documentCategoryEl.value : null,
                    corrispettivoPattuito: pattuitoEl ? Number(pattuitoEl.value) : null,
                    percentuale: percentualeEl ? Number(percentualeEl.value) : null,
                    valore: Number(valoreEl.value),
                    valore2: Number(valore2El.value),
                    valore3: Number(valore3El.value),
                    dichiarazione: dichiarazioneEl ? dichiarazioneEl.value : null,
                    esitoNegativo: esitoNegativoEl ? !!esitoNegativoEl.checked : false,
                };

                const result = {
                    min: euro(min),
                    max: euro(max),
                    mid: euro((min + max) / 2),
                    chosen: euro(chosen),
                    details,
                };

                return {
                    professione: (professioneEl && professioneEl.value) || 'commercialista',
                    riquadro: tipo,
                    criterio,
                    input,
                    result,
                };
            }

            function compute() {
                const tipo = prestazioneEl.value;
                const criterio = criterioEl.value;

                if (!tipo) {
                    resultEl.textContent = 'Seleziona una tipologia.';
                    return;
                }

                // Riquadro 10.1: importi fissi
                if (tipo === 'r10_1') {
                    const d = dichiarazioneEl.value;
                    const fixed = {
                        pf: 150,
                        pf_piva: 450,
                        sp: 550,
                        sc: 650,
                        irap: 200,
                        iva: 250,
                        '770': 150,
                        successione: 350,
                        altre: 100,
                        invio: 20,
                    };
                    if (!d || !fixed[d]) {
                        resultEl.textContent = 'Seleziona il tipo di dichiarazione (Riquadro 10.1).';
                        return;
                    }

                    const amount = fixed[d];
                    resultEl.innerHTML = `Compenso (${criterio}): <strong>${euro(amount)}</strong>`;
                    if (btnDownloadPdf) {
                        btnDownloadPdf.disabled = false;
                        btnDownloadPdf.dataset.payload = JSON.stringify({
                            professione: (professioneEl && professioneEl.value) || 'commercialista',
                            riquadro: tipo,
                            criterio,
                            input: { dichiarazione: d },
                            result: { min: euro(amount), max: euro(amount), mid: euro(amount), chosen: euro(amount), details: [] }
                        });
                    }
                    return;
                }

                const v1 = Number(valoreEl.value);
                const v2 = Number(valore2El.value);
                const v3 = Number(valore3El.value);

                if (!Number.isFinite(v1) || v1 < 0) {
                    resultEl.textContent = 'Inserisci un valore principale valido.';
                    return;
                }
                if (tipo === 'r2' && (!Number.isFinite(v2) || v2 < 0)) {
                    resultEl.textContent = 'Inserisci anche il secondo valore (Passivo accertato) per Riquadro 2.';
                    return;
                }
                if (['r4', 'r5_1', 'r6'].includes(tipo) && (!Number.isFinite(v2) || v2 < 0 || !Number.isFinite(v3) || v3 < 0)) {
                    resultEl.textContent = 'Per questa tipologia servono anche Totale attività e Ammontare passività.';
                    return;
                }

                let min = 0;
                let max = 0;
                let details = [];

                // Percentuali in forma decimale (es. 3% = 0.03)
                if (tipo === 'r1') {
                    const base = sumModeR1 ? (Number.isFinite(v2) ? (v1 + v2) : v1) : v1;
                    const t = tiered(base, [
                        { upto: 10000, ...rateRange(0.03, 0.04) },
                        { upto: 50000, ...rateRange(0.02, 0.03) },
                        { upto: Infinity, ...rateRange(0.01, 0.02) },
                    ]);
                    min = t.minTotal;
                    max = t.maxTotal;
                    details.push('Base: sommatoria componenti positivi di reddito lordi e attività.');
                    if (sumModeR1) {
                        details.push(`Somma utilizzata: ${euro(v1)} + ${euro(v2)} = ${euro(base)}`);
                    }
                } else if (tipo === 'r2') {
                    const attivo = tiered(v1, [
                        { upto: 400000, ...rateRange(0.04, 0.06) },
                        { upto: 4000000, ...rateRange(0.02, 0.03) },
                        { upto: Infinity, ...rateRange(0.0075, 0.01) },
                    ]);
                    const passivo = {
                        minTotal: v2 * 0.005,
                        maxTotal: v2 * 0.0075,
                    };
                    min = attivo.minTotal + passivo.minTotal;
                    max = attivo.maxTotal + passivo.maxTotal;
                    details.push('Valore 1: totale attivo realizzato.');
                    details.push('Valore 2: passivo accertato.');
                } else if (tipo === 'r3') {
                    const t = tiered(v1, [
                        { upto: 1000000, ...rateRange(0.008, 0.01) },
                        { upto: 3000000, ...rateRange(0.005, 0.007) },
                        { upto: Infinity, ...rateRange(0.00025, 0.0005) },
                    ]);
                    min = t.minTotal;
                    max = t.maxTotal;
                    details.push('Base: valore della perizia o valutazione.');
                } else if (tipo === 'r4') {
                    const redditiMin = v1 * 0.001;
                    const redditiMax = v1 * 0.0015;
                    const attivitaMin = v2 * 0.0005;
                    const attivitaMax = v2 * 0.00075;
                    const passivitaMin = v3 * 0.0005;
                    const passivitaMax = v3 * 0.00075;
                    min = redditiMin + attivitaMin + passivitaMin;
                    max = redditiMax + attivitaMax + passivitaMax;
                    details.push('Base 1: componenti positivi di reddito lordi.');
                    details.push('Base 2: totale attività.');
                    details.push('Base 3: ammontare passività.');
                } else if (tipo === 'r5_1') {
                    const redditiMin = v1 * 0.003;
                    const redditiMax = v1 * 0.005;
                    const attivitaMin = v2 * 0.0002;
                    const attivitaMax = v2 * 0.0006;
                    const passivitaMin = v3 * 0.0002;
                    const passivitaMax = v3 * 0.00065;
                    min = redditiMin + attivitaMin + passivitaMin;
                    max = redditiMax + attivitaMax + passivitaMax;
                    details.push('Base 1: componenti positivi di reddito lordi.');
                    details.push('Base 2: totale attività.');
                    details.push('Base 3: totale passività di fine esercizio.');
                } else if (tipo === 'r5_2') {
                    const t = tiered(v1, [
                        { upto: 50000, ...rateRange(0.03, 0.04) },
                        { upto: 100000, ...rateRange(0.01, 0.02) },
                        { upto: Infinity, ...rateRange(0.005, 0.01) },
                    ]);
                    min = t.minTotal;
                    max = t.maxTotal;
                    details.push('Base: sommatoria componenti positivi di reddito lordi.');
                } else if (tipo === 'r6') {
                    const redditi = tiered(v1, [
                        { upto: 20000000, ...rateRange(0.0002, 0.0003) },
                        { upto: Infinity, ...rateRange(0.00005, 0.0001) },
                    ]);
                    const attivitaMin = v2 * 0.0005;
                    const attivitaMax = v2 * 0.0006;
                    const passivitaMin = v3 * 0.0002;
                    const passivitaMax = v3 * 0.0003;
                    min = redditi.minTotal + attivitaMin + passivitaMin;
                    max = redditi.maxTotal + attivitaMax + passivitaMax;
                    details.push('Base 1: totale componenti positivi di reddito lordi (scaglioni).');
                    details.push('Base 2: totale attività.');
                    details.push('Base 3: ammontare passività.');
                } else if (tipo === 'r7_1') {
                    const t = tiered(v1, [
                        { upto: 1000000, ...rateRange(0.0075, 0.015) },
                        { upto: 15000000, ...rateRange(0.005, 0.0075) },
                        { upto: Infinity, ...rateRange(0.0025, 0.005) },
                    ]);
                    min = t.minTotal;
                    max = t.maxTotal;
                    details.push('Base: capitale sottoscritto.');
                } else if (tipo === 'r7_2') {
                    const t = tiered(v1, [
                        { upto: 4000000, ...rateRange(0.01, 0.015) },
                        { upto: Infinity, ...rateRange(0.005, 0.01) },
                    ]);
                    min = t.minTotal;
                    max = t.maxTotal;
                    details.push('Base: totale attività delle situazioni patrimoniali utilizzate.');
                } else if (tipo === 'r8_1') {
                    const t = tiered(v1, [
                        { upto: 2000000, ...rateRange(0.0075, 0.02) },
                        { upto: Infinity, ...rateRange(0.005, 0.0075) },
                    ]);
                    min = t.minTotal;
                    max = t.maxTotal;
                    details.push('Base: corrispettivo pattuito.');
                } else if (tipo === 'r8_2') {
                    const t = tiered(v1, [
                        { upto: 2000000, ...rateRange(0.0075, 0.01) },
                        { upto: Infinity, ...rateRange(0.005, 0.0075) },
                    ]);
                    min = t.minTotal;
                    max = t.maxTotal;
                    details.push('Base: capitale mutuato/erogato (o capitali/valori oggetto della prestazione).');
                } else if (tipo === 'r9') {
                    const t = tiered(v1, [
                        { upto: 1000000, ...rateRange(0.01, 0.02) },
                        { upto: Infinity, ...rateRange(0.007, 0.009) },
                    ]);
                    min = t.minTotal;
                    max = t.maxTotal;
                    if (esitoNegativoEl && esitoNegativoEl.checked) {
                        min = min / 2;
                        max = max / 2;
                        details.push('Riduzione applicata: procedure concluse con esito negativo (fino alla metà).');
                    }
                    details.push('Base: totale passività.');
                } else if (tipo === 'r10_2' || tipo === 'r10_3') {
                    min = v1 * 0.01;
                    max = v1 * 0.05;
                    details.push('Base: importo complessivo di imposte/tasse/contributi/sanzioni/interessi dovuti.');
                } else if (tipo === 'r11') {
                    // fino a 5.000.000: range fisso 6.000 - 8.000
                    // oltre: aliquote sul "per di piu'" in scaglioni + maggiorazione ogni 100M oltre 800M
                    const baseMin = 6000;
                    const baseMax = 8000;
                    const x = v1;

                    let extraMin = 0;
                    let extraMax = 0;

                    const cap1 = 5000000;
                    const cap2 = 100000000;
                    const cap3 = 300000000;
                    const cap4 = 800000000;

                    if (x > cap1) {
                        const s1 = Math.min(x, cap2) - cap1;
                        if (s1 > 0) {
                            extraMin += s1 * 0.00009;
                            extraMax += s1 * 0.00010;
                        }
                    }
                    if (x > cap2) {
                        const s2 = Math.min(x, cap3) - cap2;
                        if (s2 > 0) {
                            extraMin += s2 * 0.00006;
                            extraMax += s2 * 0.00009;
                        }
                    }
                    if (x > cap3) {
                        const s3 = Math.min(x, cap4) - cap3;
                        if (s3 > 0) {
                            extraMin += s3 * 0.00005;
                            extraMax += s3 * 0.00006;
                        }
                    }
                    if (x > cap4) {
                        const over = x - cap4;
                        const steps = Math.ceil(over / 100000000);
                        extraMin += steps * 7500;
                        extraMax += steps * 10000;
                    }

                    min = baseMin + extraMin;
                    max = baseMax + extraMax;
                    details.push('Base: sommatoria componenti positivi di reddito lordi e attività.');
                } else {
                    resultEl.textContent = 'Tipologia non gestita.';
                    return;
                }

                const chosen = pickRate(min, max, criterio);

                const pattuito = pattuitoEl && pattuitoEl.value !== '' ? Number(pattuitoEl.value) : null;
                const percentuale = percentualeEl && percentualeEl.value !== '' ? Number(percentualeEl.value) : null;
                const isPattuitoValid = pattuito !== null && Number.isFinite(pattuito) && pattuito >= 0;
                const diff = isPattuitoValid ? (pattuito - chosen) : null;
                const adeguamento = isPattuitoValid ? Math.max(0, chosen - pattuito) : null;
                const ratio = isPattuitoValid && chosen > 0 ? (pattuito / chosen) * 100 : null;
                resultEl.innerHTML = `
                    Compenso (${criterio}): <strong>${euro(chosen)}</strong><br>
                    Range: ${euro(min)} - ${euro(max)}<br>
                    ${isPattuitoValid ? `Corrispettivo pattuito: <strong>${euro(pattuito)}</strong><br>` : ''}
                    ${isPattuitoValid ? `Differenza (pattuito - equo): <strong>${euro(diff)}</strong><br>` : ''}
                    ${isPattuitoValid ? `Adeguamento minimo per equità: <strong>${euro(adeguamento)}</strong><br>` : ''}
                    ${isPattuitoValid && ratio !== null ? `Percentuale rispetto all'equo: <strong>${ratio.toFixed(2)}%</strong><br>` : ''}
                    ${details.length ? `<br><strong>Dettagli</strong><br>${details.map(d => `- ${d}`).join('<br>')}` : ''}
                `;

                setPreview(`
                    <div><strong>Sezione:</strong> ${(documentTypeEl && documentTypeEl.options[documentTypeEl.selectedIndex]?.textContent) || ''}</div>
                    ${documentCategoryEl && documentCategoryEl.value ? `<div><strong>Categoria:</strong> ${documentCategoryEl.options[documentCategoryEl.selectedIndex]?.textContent || ''}</div>` : ''}
                    <div style="margin-top:10px;"><strong>Compenso (${criterio}):</strong> ${euro(chosen)}</div>
                    <div><strong>Range:</strong> ${euro(min)} - ${euro(max)}</div>
                    ${isPattuitoValid ? `<div style="margin-top:10px;"><strong>Corrispettivo pattuito:</strong> ${euro(pattuito)}</div>` : ''}
                    ${isPattuitoValid ? `<div><strong>Adeguamento minimo:</strong> ${euro(adeguamento)}</div>` : ''}
                    ${Number.isFinite(percentuale) ? `<div><strong>Percentuale:</strong> ${percentuale.toFixed(2)}%</div>` : ''}
                    ${details.length ? `<div style="margin-top:10px;"><strong>Dettagli</strong><br>${details.map(d => `- ${d}`).join('<br>')}</div>` : ''}
                `);

                if (btnDownloadPdf) {
                    btnDownloadPdf.disabled = false;
                    btnDownloadPdf.dataset.payload = JSON.stringify(buildPayloadFromForm({ tipo, criterio, min, max, chosen, details }));
                }
            }

            if (prestazioneEl) {
                prestazioneEl.addEventListener('change', updateFieldVisibility);
            }
            if (btn) {
                btn.addEventListener('click', compute);
            }

            if (btnDownloadPdf) {
                btnDownloadPdf.addEventListener('click', async () => {
                    try {
                        const raw = btnDownloadPdf.dataset.payload;
                        if (!raw) {
                            alert('Esegui prima il calcolo.');
                            return;
                        }

                        btnDownloadPdf.disabled = true;
                        btnDownloadPdf.textContent = 'Generazione PDF...';

                        const payload = JSON.parse(raw);
                        if (conteggiareEl && conteggiareEl.value === 'si' && esitoNegativoEl) {
                            esitoNegativoEl.checked = true;
                        }
                        const data = await apiRequest('/api/calculations', {
                            method: 'POST',
                            body: JSON.stringify(payload)
                        });

                        await downloadDocumentPdf(data.documentId);
                    } catch (e) {
                        alert(e.message || 'Errore');
                    } finally {
                        btnDownloadPdf.textContent = 'Scarica documento (PDF)';
                        btnDownloadPdf.disabled = false;
                    }
                });
            }

            updateFieldVisibility();
            updateWelcome();
            if (typeof updateHeaderUser === 'function') {
                updateHeaderUser();
            }

            if (documentTypeEl) {
                documentTypeEl.addEventListener('change', () => {
                    applyDocType();
                });
            }

            if (documentCategoryEl) {
                documentCategoryEl.addEventListener('change', () => {
                    applyCategory();
                });
            }

            setBlockVisible(groupPattuito, true);
            setBlockVisible(groupPercentuale, true);

            applyDocType();
        })();

        function parseJwt(token) {
            if (!token || typeof token !== 'string') return {};
            const parts = token.split('.');
            if (parts.length !== 3) return {};
            try {
                return JSON.parse(atob(parts[1].replace(/-/g, '+').replace(/_/g, '/')));
            } catch {
                return {};
            }
        }

        function updateHeaderUser() {
            const token = localStorage.getItem('authToken');
            const user = parseJwt(token);
            const headerUl = document.querySelector('.ls ul');
            if (!headerUl) return;
            const isLogged = !!token && (!!user.sub || !!user.id || !!user.email);

            function isAuthLi(li) {
                const txt = (li.textContent || '').trim().toLowerCase();
                if (txt === 'login' || txt === 'registrati') return true;
                const btn = li.querySelector('button');
                if (btn && btn.onclick) {
                    const fn = btn.onclick.toString();
                    if (fn.includes('login') || fn.includes('openRegisterModal') || fn.includes('register')) return true;
                }
                const a = li.querySelector('a');
                if (a) {
                    const href = (a.getAttribute('href') || '').toLowerCase();
                    if (href.includes('login') || href.includes('register')) return true;
                }
                return false;
            }

            if (isLogged) {
                headerUl.querySelectorAll('li').forEach(li => {
                    if (isAuthLi(li)) li.style.display = 'none';
                });
                if (!headerUl.querySelector('.user-item')) {
                    const userLi = document.createElement('li');
                    userLi.className = 'user-item';
                    userLi.innerHTML = `
                        <div class="user-dropdown">
                            <button class="user-btn" onclick="toggleUserDropdown()">
                                <span class="user-avatar"><i class="fas fa-user"></i></span>
                                <span class="user-welcome-text">Ciao, ${user.nome || user.email || ''}</span>
                            </button>
                            <div id="userDropdownMenu" class="user-dropdown-menu" style="display:none;">
                                <button onclick="openProfileModal()">Profilo</button>
                                <button onclick="handleLogout()">Logout</button>
                            </div>
                        </div>
                    `;
                    headerUl.appendChild(userLi);
                }
            } else {
                headerUl.querySelectorAll('li').forEach(li => {
                    if (isAuthLi(li)) li.style.display = '';
                });
                const userLi = headerUl.querySelector('.user-item');
                if (userLi) userLi.remove();
            }
        }

        function toggleUserDropdown() {
            const menu = document.getElementById('userDropdownMenu');
            if (menu) menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
        }

        function handleLogout() {
            localStorage.removeItem('authToken');
            updateHeaderUser();
            window.location.href = 'index.html';
        }

        function openProfileModal() {
            window.location.href = 'index.html?profile=1';
        }

        document.addEventListener('click', function(event) {
            if (!event.target.closest('.user-dropdown')) {
                const menu = document.getElementById('userDropdownMenu');
                if (menu) menu.style.display = 'none';
            }
        });

        (function() {
            updateHeaderUser();
        })();
    </script>

</body>
</html>
