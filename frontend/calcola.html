<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="styles/styleIndex.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <title>Calcola - equo compenso</title>
</head>
<body class="calc-page">

    <header>
        <section class="header-img">
            <img id="main-site-logo" src="img/logo2.png" alt="logo">
        </section>

        <div class="ls">
            <ul>
                <li><a href="index.html">home</a></li>
                <li><a href="chi-siamo.html">chi siamo</a></li>
                <li><a href="calcola.html">calcola</a></li>
                <li><a href="norme.html">norme</a></li>
                <li><button onclick="window.location.href='index.html?login=1'">login</button></li>
                <li><button onclick="openRegisterModal()">registrati</button></li>
            </ul>
        </div>

    </header>
    
    <main>

        <div class="calc-page-wrap">
            <section class="calc-card" aria-label="Calcolo Equo Compenso">
                <div class="calc-card-inner">
                    <div class="calc-stepper" aria-label="Progress">
                        <div class="calc-step is-active" data-step="1"><span class="calc-step-index">1</span><span class="calc-step-label">Dati Pratica</span></div>
                        <div class="calc-step" data-step="2"><span class="calc-step-index">2</span><span class="calc-step-label">Calcolo</span></div>
                        <div class="calc-step" data-step="3"><span class="calc-step-index">3</span><span class="calc-step-label">Download</span></div>
                    </div>

                    <div class="calc-split">
                        <aside class="calc-presets" aria-label="Valori predefiniti">
                            <div class="calc-presets-title">Valori predefiniti</div>
                            <button class="calc-preset-btn" type="button" data-preset="commercialisti">Parametri Commercialisti</button>
                            <button class="calc-preset-btn" type="button" data-preset="forensi">Parametri Forensi</button>
                        </aside>

                        <div class="calc-left">
                            <form id="calcForm" class="calc-form">
                                <input type="hidden" id="professione" name="professione" value="commercialista">
                                <input type="hidden" id="prestazione" name="prestazione" value="">

                        <div class="calc-form-header">
                            <div class="form-group">
                                <label for="nome_pratica">Nome del Compenso</label>
                                <div class="calc-input">
                                    <span class="calc-icon" aria-hidden="true"><i class="fa-solid fa-tag"></i></span>
                                    <input id="nome_pratica" name="nome_pratica" type="text" placeholder="es. Progetto Ristrutturazione" required>
                                </div>
                                <div class="calc-help">Serve a identificare il calcolo e personalizzare l'intestazione del PDF.</div>
                            </div>

                            <div class="form-group">
                                <label for="cliente_nome">Nominativo Cliente / Società</label>
                                <div class="calc-input">
                                    <span class="calc-icon" aria-hidden="true"><i class="fa-solid fa-building"></i></span>
                                    <input id="cliente_nome" name="cliente_nome" type="text" placeholder="es. Rossi S.r.l." required>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="documentType">Nome del documento <span aria-hidden="true" style="color:#b00020">*</span></label>
                            <div class="calc-input">
                                <span class="calc-icon" aria-hidden="true"><i class="fa-solid fa-file-lines"></i></span>
                                <select id="documentType" name="documentType" required>
                                    <option value="" disabled selected>Seleziona</option>
                                    <option value="amministrazione_custodia">Amministrazione e custodia</option>
                                    <option value="collegio_sindacale">Collegio Sindacale</option>
                                    <option value="procedure_concorsuali">Assistenza in procedure concorsuali</option>
                                    <option value="consulente_finanziamento">Consulente finanziamento</option>
                                    <option value="consulente_economico_finanziaria">Consulente economico-finanziaria</option>
                                    <option value="consulenza_contrattuale">Consulenza contrattuale</option>
                                    <option value="consulenza_tributaria">Consulenza tributaria</option>
                                    <option value="contabilita_ordinaria">Contabilità ordinaria</option>
                                    <option value="contabilita_semplicata">Contabilità semplificata</option>
                                    <option value="dichiarazione">Dichiarazione</option>
                                    <option value="perizie_valutazioni">Perizie e valutazioni</option>
                                    <option value="formazione_bilancio">Formazione del Bilancio</option>
                                    <option value="liquidazione">Liquidazione</option>
                                    <option value="operazioni_societarie_1">Operazioni societarie 1</option>
                                    <option value="operazioni_societarie_2">Operazioni societarie 2</option>
                                    <option value="consulenza_finanziamenti">Consulenza su finanziamenti</option>
                                    <option value="revisioni_contabili">Revisioni Contabili</option>
                                    <option value="rappresentanza_tributaria">Rappresentanza Tributaria</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group" id="groupCategory">
                            <label for="documentCategory">Categoria / Prestazione</label>
                            <div class="calc-input">
                                <span class="calc-icon" aria-hidden="true"><i class="fa-solid fa-layer-group"></i></span>
                                <select id="documentCategory" name="documentCategory">
                                    <option value="" selected>Seleziona</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group" id="groupPattuito">
                            <label for="corrispettivoPattuito">Corrispettivo pattuito (€)</label>
                            <div class="calc-input">
                                <span class="calc-icon" aria-hidden="true"><i class="fa-solid fa-euro-sign"></i></span>
                                <input id="corrispettivoPattuito" name="corrispettivoPattuito" type="number" min="0" step="0.01" placeholder="0,00">
                            </div>
                        </div>

                        <div class="form-group" id="groupPercentuale">
                            <label for="percentuale">Percentuale (%)</label>
                            <div class="calc-input">
                                <span class="calc-icon" aria-hidden="true"><i class="fa-solid fa-percent"></i></span>
                                <input id="percentuale" name="percentuale" type="number" min="0" max="100" step="0.01" placeholder="0,00">
                            </div>
                            <div class="calc-help" id="helpPercentuale">Definisce lo scostamento tra minimo e massimo dei parametri ministeriali: 0% = minimo, 50% = medio, 100% = massimo (es. 90% tende verso il limite superiore). Se vuota, vale il criterio Min/Medio/Massimo.</div>
                        </div>

                        <div class="form-group">
                            <label for="criterio">Criterio calcolo</label>
                            <div class="calc-input">
                                <span class="calc-icon" aria-hidden="true"><i class="fa-solid fa-sliders"></i></span>
                                <select id="criterio" name="criterio" required>
                                    <option value="min">Minimo</option>
                                    <option value="medio" selected>Medio</option>
                                    <option value="max">Massimo</option>
                                </select>
                            </div>
                            <div class="calc-help">Parametro generale che valuta importanza e difficoltà della pratica (Minimo, Medio, Massimo).</div>
                        </div>

                        <div class="form-group" id="groupAliquotaSc1">
                            <label for="aliquota_scaglione_1">Aliquota Fascia 1 (Fino a 2M)</label>
                            <div class="calc-input">
                                <span class="calc-icon" aria-hidden="true"><i class="fa-solid fa-percent"></i></span>
                                <input id="aliquota_scaglione_1" name="aliquota_scaglione_1" type="number" min="0.0075" max="0.02" step="0.0001" value="0.0075">
                            </div>
                        </div>

                        <div class="form-group" id="groupAliquotaSc2">
                            <label for="aliquota_scaglione_2">Aliquota Fascia 2 (Oltre 2M)</label>
                            <div class="calc-input">
                                <span class="calc-icon" aria-hidden="true"><i class="fa-solid fa-percent"></i></span>
                                <input id="aliquota_scaglione_2" name="aliquota_scaglione_2" type="number" min="0.005" max="0.0075" step="0.0001" value="0.005">
                            </div>
                        </div>

                        <div class="form-group" id="groupIntensitySc1">
                            <label for="intensity_scaglione_1">Intensità Fascia 1 (Fino a 2M)</label>
                            <div class="calc-input">
                                <span class="calc-icon" aria-hidden="true"><i class="fa-solid fa-gauge-high"></i></span>
                                <select id="intensity_scaglione_1" name="intensity_scaglione_1">
                                    <option value="min" selected>Minimo</option>
                                    <option value="medio">Medio</option>
                                    <option value="max">Massimo</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group" id="groupIntensitySc2">
                            <label for="intensity_scaglione_2">Intensità Fascia 2 (Oltre 2M)</label>
                            <div class="calc-input">
                                <span class="calc-icon" aria-hidden="true"><i class="fa-solid fa-gauge-high"></i></span>
                                <select id="intensity_scaglione_2" name="intensity_scaglione_2">
                                    <option value="min" selected>Minimo</option>
                                    <option value="medio">Medio</option>
                                    <option value="max">Massimo</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group" id="groupAliquotaConsulenza">
                            <label for="aliquota_consulenza">Aliquota applicata (solo sezione "Consulenza tributaria")</label>
                            <div class="calc-input">
                                <span class="calc-icon" aria-hidden="true"><i class="fa-solid fa-percent"></i></span>
                                <input id="aliquota_consulenza" name="aliquota_consulenza" type="number" min="0.01" max="0.05" step="0.0001" value="0.01">
                            </div>
                        </div>

                        <div class="form-group" id="groupConteggiare">
                            <label for="conteggiare">Conteggiare?</label>
                            <div class="calc-input">
                                <span class="calc-icon" aria-hidden="true"><i class="fa-solid fa-calculator"></i></span>
                                <select id="conteggiare" name="conteggiare">
                                    <option value="no" selected>No</option>
                                    <option value="si">Sì</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label id="labelValore" for="valore">Valore</label>
                            <div class="calc-input">
                                <span class="calc-icon" aria-hidden="true"><i class="fa-solid fa-scale-balanced"></i></span>
                                <input id="valore" name="valore" type="number" min="0" step="0.01" placeholder="0,00" required>
                            </div>
                            <div class="calc-help" id="helpValore">Rappresenta il parametro di base espresso in euro (es. capitale, passività, attivo, reddito).</div>
                        </div>

                        <div class="form-group">
                            <label id="labelValore2" for="valore2">Secondo valore</label>
                            <div class="calc-input">
                                <span class="calc-icon" aria-hidden="true"><i class="fa-solid fa-scale-unbalanced"></i></span>
                                <input id="valore2" name="valore2" type="number" min="0" step="0.01" placeholder="0,00">
                            </div>
                            <div class="calc-help" id="helpValore2" style="display:none;"></div>
                        </div>

                        <div class="form-group">
                            <label id="labelValore3" for="valore3">Terzo valore</label>
                            <div class="calc-input">
                                <span class="calc-icon" aria-hidden="true"><i class="fa-solid fa-chart-line"></i></span>
                                <input id="valore3" name="valore3" type="number" min="0" step="0.01" placeholder="0,00">
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="dichiarazione">Dichiarazione (solo sezione "Dichiarazione")</label>
                            <div class="calc-input">
                                <span class="calc-icon" aria-hidden="true"><i class="fa-solid fa-file-signature"></i></span>
                                <select id="dichiarazione" name="dichiarazione">
                                    <option value="" selected>N/A</option>
                                    <option value="pf">Dichiarazione redditi persone fisiche</option>
                                    <option value="pf_piva">Dichiarazione redditi PF con partita IVA</option>
                                    <option value="sp">Dichiarazione redditi società di persone</option>
                                    <option value="sc">Dichiarazione redditi società di capitali</option>
                                    <option value="irap">Dichiarazione IRAP</option>
                                    <option value="iva">Dichiarazione IVA</option>
                                    <option value="770">Dichiarazione sostituti d'imposta</option>
                                    <option value="invio">Invio telematico</option>
                                    <option value="successione">Dichiarazione di successione</option>
                                    <option value="altre">Altre dichiarazioni e comunicazioni</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group" id="groupDichiarazioniMulti">
                            <label>Assistenza tributaria (Dichiarazioni) - seleziona le voci</label>
                            <div class="calc-checkbox"><input id="dich_pf_no_piva" type="checkbox" name="dich_multi" value="pf_no_piva"><label for="dich_pf_no_piva">Redditi Persone Fisiche (no P.IVA) — € 150,00</label></div>
                            <div class="calc-checkbox"><input id="dich_pf_piva" type="checkbox" name="dich_multi" value="pf_piva"><label for="dich_pf_piva">Redditi Persone Fisiche con P.IVA — € 450,00</label></div>
                            <div class="calc-checkbox"><input id="dich_soc_persone" type="checkbox" name="dich_multi" value="soc_persone"><label for="dich_soc_persone">Redditi Società di Persone — € 550,00</label></div>
                            <div class="calc-checkbox"><input id="dich_soc_capitali" type="checkbox" name="dich_multi" value="soc_capitali"><label for="dich_soc_capitali">Redditi Società di Capitali — € 650,00</label></div>
                            <div class="calc-checkbox"><input id="dich_irap" type="checkbox" name="dich_multi" value="irap"><label for="dich_irap">Dichiarazione IRAP — € 200,00</label></div>
                            <div class="calc-checkbox"><input id="dich_iva" type="checkbox" name="dich_multi" value="iva"><label for="dich_iva">Dichiarazione IVA — € 250,00</label></div>
                            <div class="calc-checkbox"><input id="dich_sostituti" type="checkbox" name="dich_multi" value="sostituti"><label for="dich_sostituti">Sostituti d'Imposta — € 150,00</label></div>
                            <div class="calc-checkbox"><input id="dich_successione" type="checkbox" name="dich_multi" value="successione"><label for="dich_successione">Dichiarazione di Successione — € 350,00</label></div>
                            <div class="calc-checkbox"><input id="dich_altre" type="checkbox" name="dich_multi" value="altre"><label for="dich_altre">Altre comunicazioni/dichiarazioni — € 100,00</label></div>
                            <div class="calc-checkbox"><input id="dich_invio" type="checkbox" name="dich_multi" value="invio"><label for="dich_invio">Invio Telematico (per singola voce) — € 20,00</label></div>
                        </div>

                        <div class="form-group" id="groupEsitoNegativo">
                            <label>Procedure concorsuali (solo sezione "Assistenza in procedure concorsuali")</label>
                            <div class="calc-checkbox">
                                <input id="esitoNegativo" name="esitoNegativo" type="checkbox">
                                <label for="esitoNegativo">Esito negativo (riduzione fino alla metà)</label>
                            </div>
                        </div>

                        <div class="form-group" id="groupRuoloSindaco">
                            <label for="ruoloSindaco">Carica ricoperta (solo sezione "Collegio Sindacale")</label>
                            <div class="calc-input">
                                <span class="calc-icon" aria-hidden="true"><i class="fa-solid fa-user-tie"></i></span>
                                <select id="ruoloSindaco" name="ruoloSindaco">
                                    <option value="membro" selected>Membro</option>
                                    <option value="presidente">Presidente</option>
                                    <option value="sindaco_unico">Sindaco Unico</option>
                                </select>
                            </div>
                            <div class="calc-help">Applica aumenti automatici: +50% per il Presidente o +100% per il Sindaco Unico.</div>
                        </div>

                        <div class="form-group" id="groupRiduzioneComma2">
                            <label>Collegio Sindacale (riduzioni)</label>
                            <div class="calc-checkbox">
                                <input id="riduzioneComma2" name="riduzioneComma2" type="checkbox">
                                <label for="riduzioneComma2">Società di sola amministrazione/godimento o liquidazione (riduzione fino alla metà)</label>
                            </div>
                        </div>

                        <div class="calc-action-bar">
                            <button id="btn_calcola" class="calc-btn calc-btn-primary" type="button">
                                <span class="calc-btn-text">ELABORA COMPENSO</span>
                                <span class="calc-btn-progress" aria-hidden="true"><span class="calc-btn-progress-bar"></span></span>
                            </button>
                            <button id="btn_scarica" class="calc-btn calc-btn-outline" type="button" disabled>GENERA E SCARICA PDF</button>
                            <button id="btn_reset" class="calc-btn calc-btn-link" type="reset">RESET CAMPI</button>
                        </div>

                        <div id="calcolaResult" class="calcola-result">Risultato: in attesa di calcolo.</div>

                            </form>
                        </div>

                        <div class="calc-right" aria-label="Anteprima">
                            <div class="calc-preview">
                                <div class="calc-preview-title">Anteprima Istanza</div>
                                <div id="documentPreview" class="calc-preview-body">Seleziona una sezione e inserisci i dati per vedere l'anteprima.</div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>

    </main>
    
    <footer>
        <div class="footer-content">
            <p>&copy; 2025 equocompenso. All rights reserved.</p>
        </div>
    </footer>

    <script>
        (function() {
            const token = localStorage.getItem('authToken');
            if (!token) {
                localStorage.setItem('postLoginRedirect', 'calcola.html');
                window.location.replace('index.html?login=1');
            }
        })();

        function openRegisterModal() {
            window.location.href = 'index.html?register=1';
        }

        (function() {
            const prestazioneEl = document.getElementById('prestazione');
            const documentTypeEl = document.getElementById('documentType');
            const documentCategoryEl = document.getElementById('documentCategory');
            const criterioEl = document.getElementById('criterio');
            const valoreEl = document.getElementById('valore');
            const valore2El = document.getElementById('valore2');
            const valore3El = document.getElementById('valore3');
            const dichiarazioneEl = document.getElementById('dichiarazione');
            const groupDichiarazioniMulti = document.getElementById('groupDichiarazioniMulti');
            const esitoNegativoEl = document.getElementById('esitoNegativo');
            const ruoloSindacoEl = document.getElementById('ruoloSindaco');
            const riduzioneComma2El = document.getElementById('riduzioneComma2');
            const aliquotaSc1El = document.getElementById('aliquota_scaglione_1');
            const aliquotaSc2El = document.getElementById('aliquota_scaglione_2');
            const intensitySc1El = document.getElementById('intensity_scaglione_1');
            const intensitySc2El = document.getElementById('intensity_scaglione_2');
            const aliquotaConsulenzaEl = document.getElementById('aliquota_consulenza');
            const conteggiareEl = document.getElementById('conteggiare');
            const pattuitoEl = document.getElementById('corrispettivoPattuito');
            const percentualeEl = document.getElementById('percentuale');
            const groupCategory = document.getElementById('groupCategory');
            const groupPattuito = document.getElementById('groupPattuito');
            const groupPercentuale = document.getElementById('groupPercentuale');
            const groupConteggiare = document.getElementById('groupConteggiare');
            const groupEsitoNegativo = document.getElementById('groupEsitoNegativo');
            const groupRuoloSindaco = document.getElementById('groupRuoloSindaco');
            const groupRiduzioneComma2 = document.getElementById('groupRiduzioneComma2');
            const groupAliquotaSc1 = document.getElementById('groupAliquotaSc1');
            const groupAliquotaSc2 = document.getElementById('groupAliquotaSc2');
            const groupIntensitySc1 = document.getElementById('groupIntensitySc1');
            const groupIntensitySc2 = document.getElementById('groupIntensitySc2');
            const groupAliquotaConsulenza = document.getElementById('groupAliquotaConsulenza');
            const helpValoreEl = document.getElementById('helpValore');
            const helpValore2El = document.getElementById('helpValore2');
            const btn = document.getElementById('btn_calcola');
            const btnDownloadPdf = document.getElementById('btn_scarica');
            const resultEl = document.getElementById('calcolaResult');
            const professioneEl = document.getElementById('professione');
            const previewEl = document.getElementById('documentPreview');
            const welcomeEl = null;

            const nomePraticaEl = document.getElementById('nome_pratica');
            const clienteNomeEl = document.getElementById('cliente_nome');

            const presetButtons = document.querySelectorAll('[data-preset]');

            function setStepper(step) {
                document.querySelectorAll('.calc-stepper .calc-step').forEach(el => {
                    const n = Number(el.getAttribute('data-step'));
                    el.classList.toggle('is-active', n === step);
                    el.classList.toggle('is-done', n < step);
                });
            }

            if (presetButtons && presetButtons.length) {
                presetButtons.forEach(b => {
                    b.addEventListener('click', () => {
                        const id = b.getAttribute('data-preset') || '';
                        applyPreset(id);
                    });
                });
            }

            function setResult(message, isError) {
                if (!resultEl) return;
                resultEl.textContent = message;
                resultEl.classList.toggle('is-error', !!isError);
            }

            function clearFieldErrors() {
                document.querySelectorAll('.calc-field-error').forEach(el => el.remove());
                document.querySelectorAll('.calc-input-error').forEach(el => el.classList.remove('calc-input-error'));
            }

            function showFieldError(inputEl, message) {
                if (!inputEl) return;
                const group = inputEl.closest('.form-group');
                if (!group) return;
                const wrap = inputEl.closest('.calc-input');
                if (wrap) wrap.classList.add('calc-input-error');
                const existing = group.querySelector('.calc-field-error');
                if (existing) existing.remove();
                const err = document.createElement('div');
                err.className = 'calc-field-error';
                err.textContent = message;
                group.appendChild(err);
            }

            const labelValore = document.getElementById('labelValore');
            const labelValore2 = document.getElementById('labelValore2');
            const labelValore3 = document.getElementById('labelValore3');

            let sumModeR1 = false;

            function setPreview(html) {
                if (!previewEl) return;
                previewEl.innerHTML = html;
            }

            function applyPreset(presetId) {
                const presets = {
                    commercialisti: {
                        label: 'Parametri Commercialisti',
                        documentType: 'amministrazione_custodia',
                        documentCategory: 'amm_custodia_base',
                        criterio: 'medio',
                        percentuale: 100,
                        valore: 50000,
                        valore2: 250000,
                        valore3: '',
                        corrispettivoPattuito: '',
                        dichiarazione: '',
                        conteggiare: 'no',
                        esitoNegativo: false,
                    },
                    forensi: {
                        label: 'Parametri Forensi',
                        documentType: 'perizie_valutazioni',
                        documentCategory: 'perizia',
                        criterio: 'medio',
                        percentuale: 100,
                        valore: 150000,
                        valore2: '',
                        valore3: '',
                        corrispettivoPattuito: '',
                        dichiarazione: '',
                        conteggiare: 'no',
                        esitoNegativo: false,
                    },
                };

                const p = presets[presetId];
                if (!p) return;

                clearFieldErrors();

                if (documentTypeEl) documentTypeEl.value = p.documentType;
                applyDocType();

                if (documentCategoryEl && p.documentCategory) {
                    documentCategoryEl.value = p.documentCategory;
                    applyCategory();
                }

                if (criterioEl && p.criterio) criterioEl.value = p.criterio;
                if (percentualeEl != null && p.percentuale !== undefined) percentualeEl.value = String(p.percentuale);
                if (valoreEl != null && p.valore !== undefined) valoreEl.value = String(p.valore);
                if (valore2El != null) valore2El.value = p.valore2 === '' ? '' : String(p.valore2);
                if (valore3El != null) valore3El.value = p.valore3 === '' ? '' : String(p.valore3);
                if (pattuitoEl != null) pattuitoEl.value = p.corrispettivoPattuito === '' ? '' : String(p.corrispettivoPattuito);
                if (dichiarazioneEl != null) dichiarazioneEl.value = p.dichiarazione || '';
                if (conteggiareEl != null && p.conteggiare) conteggiareEl.value = p.conteggiare;
                if (esitoNegativoEl != null) esitoNegativoEl.checked = !!p.esitoNegativo;

                setStepper(1);
                setResult(`Preset applicato: ${p.label}.`, false);
                renderDraftPreview();
            }

            function setBlockVisible(el, visible) {
                if (!el) return;
                el.style.display = visible ? '' : 'none';
            }

            function setInputGroupVisible(inputEl, visible) {
                if (!inputEl) return;
                const group = inputEl.closest('.form-group');
                if (!group) return;
                group.style.display = visible ? '' : 'none';
            }

            const docConfig = {
                amministrazione_custodia: {
                    riquadro: 'r1',
                    sumR1: true,
                    labels: {
                        v1: 'Componenti positivi di redditi lordi (€)',
                        v2: 'Totale attività (€)',
                    },
                    show: { v2: true, v3: false, dichiarazione: false, esitoNegativo: false, conteggiare: false, ruoloSindaco: false, riduzioneComma2: false },
                    showPattuito: true,
                    showPercentuale: true,
                },
                collegio_sindacale: {
                    riquadro: 'r11',
                    sumR1: false,
                    labels: {
                        v1: 'Componenti positivi reddito lordo (€)',
                        v2: 'Totale attività (€)',
                    },
                    show: { v2: true, v3: false, dichiarazione: false, esitoNegativo: false, conteggiare: false, ruoloSindaco: true, riduzioneComma2: true },
                    showPattuito: true,
                    showPercentuale: true,
                },
                contabilita_ordinaria: {
                    riquadro: 'r5_1',
                    sumR1: false,
                    labels: {
                        v1: 'Totale Componenti Positivi di Reddito Lordi (€)',
                        v2: 'Totale Attività (€)',
                        v3: 'Ammontare delle Passività (Bilancio fine esercizio) (€)',
                    },
                    show: { v2: true, v3: true, dichiarazione: false, esitoNegativo: false, conteggiare: false, ruoloSindaco: false, riduzioneComma2: false, aliquotaSc1: false, aliquotaSc2: false, intensitySc1: false, intensitySc2: false },
                    showPattuito: false,
                    showPercentuale: true,
                },
                contabilita_semplicata: {
                    riquadro: 'r5_2',
                    sumR1: false,
                    labels: {
                        v1: 'Componenti Positivi di Reddito Lordi (€)',
                    },
                    show: { v2: false, v3: false, dichiarazione: false, esitoNegativo: false, conteggiare: false, ruoloSindaco: false, riduzioneComma2: false },
                    showPattuito: true,
                    showPercentuale: true,
                },
                formazione_bilancio: {
                    riquadro: 'r4',
                    sumR1: false,
                    labels: {
                        v1: 'TOTALE COMPONENTI POSITIVI DI REDDITO LORDI (€)',
                        v2: 'TOTALE DELLE ATTIVITA\' (€)',
                        v3: 'AMMONTARE DELLE PASSIVITA\' (€)',
                    },
                    show: { v2: true, v3: true, dichiarazione: false, esitoNegativo: false, conteggiare: false, ruoloSindaco: false, riduzioneComma2: false },
                    showPattuito: true,
                    showPercentuale: true,
                },
                procedure_concorsuali: {
                    riquadro: 'r9',
                    sumR1: false,
                    labels: { v1: 'Totale delle passività (€)' },
                    show: { v2: false, v3: false, dichiarazione: false, esitoNegativo: true, conteggiare: true, ruoloSindaco: false, riduzioneComma2: false },
                    showPattuito: true,
                    showPercentuale: true,
                },
                consulente_finanziamento: {
                    riquadro: 'r8_2',
                    sumR1: false,
                    labels: { v1: 'Capitale mutuato/finanziato (€)' },
                    show: { v2: false, v3: false, dichiarazione: false, esitoNegativo: false, conteggiare: false, ruoloSindaco: false, riduzioneComma2: false, aliquotaSc1: false, aliquotaSc2: false, intensitySc1: false, intensitySc2: false },
                    showPattuito: true,
                    showPercentuale: true,
                },
                consulente_economico_finanziaria: {
                    riquadro: 'r8_2',
                    sumR1: false,
                    labels: { v1: 'Capitali/valori econ-finanziari (€)' },
                    show: { v2: false, v3: false, dichiarazione: false, esitoNegativo: false, conteggiare: false, ruoloSindaco: false, riduzioneComma2: false, aliquotaSc1: false, aliquotaSc2: false, intensitySc1: false, intensitySc2: false },
                    showPattuito: true,
                    showPercentuale: true,
                },
                consulenza_finanziamenti: {
                    riquadro: 'r8_2',
                    sumR1: false,
                    labels: { v1: 'Capitale Mutuato/Finanziato/Contributi (€)' },
                    show: { v2: false, v3: false, dichiarazione: false, esitoNegativo: false, conteggiare: false, ruoloSindaco: false, riduzioneComma2: false, aliquotaSc1: false, aliquotaSc2: false, intensitySc1: true, intensitySc2: true },
                    showPattuito: true,
                    showPercentuale: true,
                },
                consulenza_tributaria: {
                    riquadro: 'r10_3',
                    sumR1: false,
                    labels: { v1: 'Imposte, sanzioni e interessi in contestazione (€)' },
                    show: { v2: false, v3: false, dichiarazione: false, esitoNegativo: false, conteggiare: false, ruoloSindaco: false, riduzioneComma2: false, aliquotaSc1: false, aliquotaSc2: false, intensitySc1: false, intensitySc2: false, aliquotaConsulenza: true },
                    showPattuito: true,
                    showPercentuale: true,
                },

                rappresentanza_tributaria: {
                    riquadro: 'r10_2',
                    sumR1: false,
                    labels: { v1: 'Valore della Pratica / Importo Complessivo (€)' },
                    show: { v2: false, v3: false, dichiarazione: false, dichiarazioniMulti: false, esitoNegativo: false, conteggiare: false, ruoloSindaco: false, riduzioneComma2: false, aliquotaSc1: false, aliquotaSc2: false, intensitySc1: false, intensitySc2: false, aliquotaConsulenza: false },
                    showPattuito: true,
                    showPercentuale: true,
                },

                liquidazione: {
                    riquadro: 'r2',
                    sumR1: false,
                    labels: {
                        v1: 'Totale Attivo Realizzato (€)',
                        v2: 'Totale Passivo Accertato (€)',
                    },
                    show: { v2: true, v3: false, dichiarazione: false, esitoNegativo: false, conteggiare: false, ruoloSindaco: false, riduzioneComma2: false, aliquotaSc1: false, aliquotaSc2: false, intensitySc1: false, intensitySc2: false },
                    showPattuito: true,
                    showPercentuale: true,
                },

                operazioni_societarie_1: {
                    riquadro: 'r7_1',
                    sumR1: false,
                    labels: { v1: 'Capitale Sottoscritto (€)' },
                    show: { v2: false, v3: false, dichiarazione: false, dichiarazioniMulti: false, esitoNegativo: false, conteggiare: false, ruoloSindaco: false, riduzioneComma2: false, aliquotaSc1: false, aliquotaSc2: false, intensitySc1: false, intensitySc2: false, aliquotaConsulenza: false },
                    showPattuito: true,
                    showPercentuale: true,
                },

                operazioni_societarie_2: {
                    riquadro: 'r7_2',
                    sumR1: false,
                    labels: { v1: 'Totale Attività Situazioni Patrimoniali (€)' },
                    show: { v2: false, v3: false, dichiarazione: false, dichiarazioniMulti: false, esitoNegativo: false, conteggiare: false, ruoloSindaco: false, riduzioneComma2: false, aliquotaSc1: false, aliquotaSc2: false, intensitySc1: false, intensitySc2: false, aliquotaConsulenza: false },
                    showPattuito: true,
                    showPercentuale: true,
                },
                consulenza_contrattuale: {
                    riquadro: 'r8_1',
                    sumR1: false,
                    labels: { v1: 'Corrispettivo pattuito (€)' },
                    show: { v2: false, v3: false, dichiarazione: false, esitoNegativo: false, conteggiare: false, ruoloSindaco: false, riduzioneComma2: false, aliquotaSc1: true, aliquotaSc2: true, intensitySc1: false, intensitySc2: false },
                    showPattuito: false,
                    showPercentuale: true,
                },
                dichiarazione: {
                    riquadro: 'r10_1',
                    sumR1: false,
                    labels: { },
                    show: { v2: false, v3: false, dichiarazione: false, esitoNegativo: false, conteggiare: false, ruoloSindaco: false, riduzioneComma2: false, dichiarazioniMulti: true },
                    showPattuito: true,
                    showPercentuale: true,
                },
                perizie_valutazioni: {
                    riquadro: 'r3',
                    sumR1: false,
                    labels: { v1: 'Valore risultante dalla perizia/valutazione (€)' },
                    show: { v2: false, v3: false, dichiarazione: false, esitoNegativo: false, conteggiare: false, ruoloSindaco: false, riduzioneComma2: false },
                    showPattuito: true,
                    showPercentuale: true,
                },

                revisioni_contabili: {
                    riquadro: 'r4',
                    sumR1: false,
                    labels: {
                        v1: 'Totale Componenti Positivi di Reddito Lordi (€)',
                        v2: 'Totale delle Attività (€)',
                        v3: 'Ammontare delle Passività (€)',
                    },
                    show: { v2: true, v3: true, dichiarazione: false, dichiarazioniMulti: false, esitoNegativo: false, conteggiare: false, ruoloSindaco: false, riduzioneComma2: false, aliquotaSc1: false, aliquotaSc2: false, intensitySc1: false, intensitySc2: false, aliquotaConsulenza: false },
                    showPattuito: true,
                    showPercentuale: true,
                },
                default: {
                    riquadro: 'r1',
                    sumR1: false,
                    labels: { v1: 'Valore di riferimento (€)' },
                    show: { v2: false, v3: false, dichiarazione: false, esitoNegativo: false, conteggiare: false, ruoloSindaco: false, riduzioneComma2: false },
                    showPattuito: true,
                    showPercentuale: true,
                }
            };

            const docCategories = {
                amministrazione_custodia: [
                    { id: 'amm_custodia_base', label: 'Attività di amministrazione e custodia (base)', percent: 100 },
                    { id: 'amm_custodia_complessa', label: 'Attività complessa / urgenza', percent: 120 },
                ],
                procedure_concorsuali: [
                    { id: 'proc_assistenza', label: 'Assistenza in procedure concorsuali', percent: 100 },
                    { id: 'proc_esito_neg', label: 'Esito negativo (riduzione)', percent: 50 },
                ],
                dichiarazione: [
                    { id: 'dich_pf', label: 'Dichiarazione PF', percent: 100 },
                    { id: 'dich_sc', label: 'Dichiarazione Società di capitali', percent: 100 },
                ],
                perizie_valutazioni: [
                    { id: 'perizia', label: 'Perizia / Valutazione', percent: 100 },
                ],
            };

            function fillCategoryOptions() {
                if (!documentCategoryEl) return;
                const key = documentTypeEl ? documentTypeEl.value : '';
                const list = docCategories[key] || [];

                documentCategoryEl.innerHTML = '<option value="" selected>Seleziona</option>';
                for (const item of list) {
                    const opt = document.createElement('option');
                    opt.value = item.id;
                    opt.textContent = item.label;
                    opt.dataset.percent = String(item.percent);
                    documentCategoryEl.appendChild(opt);
                }

                setBlockVisible(groupCategory, list.length > 0);
            }

            function applyCategory() {
                if (!documentCategoryEl || !percentualeEl) return;
                const opt = documentCategoryEl.options[documentCategoryEl.selectedIndex];
                const p = opt && opt.dataset && opt.dataset.percent ? Number(opt.dataset.percent) : NaN;
                if (Number.isFinite(p)) {
                    percentualeEl.value = String(p);
                }
            }

            function applyDocType() {
                const key = documentTypeEl ? documentTypeEl.value : '';
                const cfg = docConfig[key] || docConfig.default;

                if (prestazioneEl) prestazioneEl.value = cfg.riquadro;

                if (labelValore) labelValore.textContent = cfg.labels.v1 || 'Valore (€)';
                if (labelValore2) labelValore2.textContent = cfg.labels.v2 || 'Secondo valore (€)';
                if (labelValore3) labelValore3.textContent = cfg.labels.v3 || 'Terzo valore (€)';

                if (helpValoreEl) {
                    const l1 = labelValore ? String(labelValore.textContent || '') : '';
                    if (/reddito|componenti positivi/i.test(l1)) {
                        helpValoreEl.textContent = 'Sommatoria dei ricavi e proventi (componenti positivi).';
                    } else {
                        helpValoreEl.textContent = 'Rappresenta il parametro di base espresso in euro (es. capitale, passività, attivo, reddito).';
                    }
                }
                if (helpValore2El) {
                    const l2 = labelValore2 ? String(labelValore2.textContent || '') : '';
                    if (/attivit/i.test(l2)) {
                        helpValore2El.textContent = 'Valore complessivo dello Stato Patrimoniale (Totale Attivo).';
                        helpValore2El.style.display = '';
                    } else {
                        helpValore2El.textContent = '';
                        helpValore2El.style.display = 'none';
                    }
                }

                setInputGroupVisible(valore2El, !!cfg.show.v2);
                setInputGroupVisible(valore3El, !!cfg.show.v3);
                setInputGroupVisible(dichiarazioneEl, !!cfg.show.dichiarazione);
                setBlockVisible(groupDichiarazioniMulti, !!(cfg.show && cfg.show.dichiarazioniMulti));
                setBlockVisible(groupEsitoNegativo, !!cfg.show.esitoNegativo);
                setBlockVisible(groupConteggiare, !!cfg.show.conteggiare);
                setBlockVisible(groupRuoloSindaco, !!cfg.show.ruoloSindaco);
                setBlockVisible(groupRiduzioneComma2, !!cfg.show.riduzioneComma2);
                setBlockVisible(groupAliquotaSc1, !!(cfg.show && cfg.show.aliquotaSc1));
                setBlockVisible(groupAliquotaSc2, !!(cfg.show && cfg.show.aliquotaSc2));
                setBlockVisible(groupIntensitySc1, !!(cfg.show && cfg.show.intensitySc1));
                setBlockVisible(groupIntensitySc2, !!(cfg.show && cfg.show.intensitySc2));
                setBlockVisible(groupAliquotaConsulenza, !!(cfg.show && cfg.show.aliquotaConsulenza));

                if (valoreEl) {
                    valoreEl.placeholder = key === 'consulenza_contrattuale'
                        ? 'Inserisci il valore del contratto'
                        : (key === 'rappresentanza_tributaria'
                            ? 'Inserisci il valore della pratica'
                            : '0,00');
                }

                if (cfg.show && cfg.show.aliquotaSc1 && aliquotaSc1El && String(aliquotaSc1El.value || '').trim() === '') {
                    aliquotaSc1El.value = '0.0075';
                }
                if (cfg.show && cfg.show.aliquotaSc2 && aliquotaSc2El && String(aliquotaSc2El.value || '').trim() === '') {
                    aliquotaSc2El.value = '0.005';
                }

                if (cfg.show && cfg.show.intensitySc1 && intensitySc1El && String(intensitySc1El.value || '').trim() === '') {
                    intensitySc1El.value = 'min';
                }
                if (cfg.show && cfg.show.intensitySc2 && intensitySc2El && String(intensitySc2El.value || '').trim() === '') {
                    intensitySc2El.value = 'min';
                }

                if (cfg.show && cfg.show.aliquotaConsulenza && aliquotaConsulenzaEl && String(aliquotaConsulenzaEl.value || '').trim() === '') {
                    aliquotaConsulenzaEl.value = '0.01';
                }

                setBlockVisible(groupPattuito, cfg.showPattuito !== false);
                setBlockVisible(groupPercentuale, cfg.showPercentuale !== false);

                // required
                if (valoreEl) valoreEl.required = cfg.riquadro !== 'r10_1';
                if (valore2El) valore2El.required = !!cfg.show.v2;
                if (valore3El) valore3El.required = !!cfg.show.v3;

                // reset buttons/preview
                if (btnDownloadPdf) {
                    btnDownloadPdf.disabled = true;
                    btnDownloadPdf.dataset.payload = '';
                }
                setPreview('Seleziona una sezione e inserisci i dati per vedere l\'anteprima.');

                fillCategoryOptions();
                if (percentualeEl) percentualeEl.value = '';
                if (pattuitoEl) pattuitoEl.value = '';
            }

            function setEnabled(el, enabled) {
                if (!el) return;
                el.disabled = !enabled;
                if (!enabled) {
                    if (el.tagName === 'SELECT') el.value = '';
                    if (el.tagName === 'INPUT') {
                        if (el.type === 'checkbox') el.checked = false;
                        else el.value = '';
                    }
                }
            }

            function setGroupVisible(el, visible) {
                if (!el) return;
                const group = el.closest('.form-group');
                if (!group) return;
                group.style.display = visible ? '' : 'none';
            }

            function updateFieldVisibility() {
                const docKey = documentTypeEl ? documentTypeEl.value : '';
                const cfg = docKey && docConfig[docKey] ? docConfig[docKey] : null;
                const tipo = prestazioneEl ? prestazioneEl.value : (cfg ? cfg.riquadro : '');

                const needsV2 = cfg ? !!(cfg.show && cfg.show.v2) : ['r2', 'r4', 'r5_1', 'r6'].includes(tipo);
                const needsV3 = cfg ? !!(cfg.show && cfg.show.v3) : ['r4', 'r5_1', 'r6'].includes(tipo);

                // Manteniamo la logica originale per i riquadri "puri" (fallback)
                // valore = principale. valore2 = secondario (quando serve). valore3 = terzo (quando serve). dichiarazione = solo Riquadro 10.1
                setEnabled(valoreEl, tipo !== 'r10_1');
                setEnabled(valore2El, needsV2);
                setEnabled(valore3El, needsV3);
                setEnabled(dichiarazioneEl, !!(cfg && cfg.show && cfg.show.dichiarazione));
                setEnabled(esitoNegativoEl, tipo === 'r9');
                setEnabled(ruoloSindacoEl, tipo === 'r11');
                setEnabled(riduzioneComma2El, tipo === 'r11');
                setEnabled(aliquotaSc1El, !!(cfg && cfg.show && cfg.show.aliquotaSc1));
                setEnabled(aliquotaSc2El, !!(cfg && cfg.show && cfg.show.aliquotaSc2));
                setEnabled(intensitySc1El, !!(cfg && cfg.show && cfg.show.intensitySc1));
                setEnabled(intensitySc2El, !!(cfg && cfg.show && cfg.show.intensitySc2));
                setEnabled(aliquotaConsulenzaEl, !!(cfg && cfg.show && cfg.show.aliquotaConsulenza));

                if (tipo === 'r10_1') {
                    valoreEl.required = false;
                    valore2El.required = false;
                    valore3El.required = false;
                } else {
                    valoreEl.required = true;
                    valore2El.required = needsV2;
                    valore3El.required = needsV3;
                }

                if (!cfg) {
                    if (labelValore) labelValore.textContent = 'Valore di riferimento (€)';
                    if (labelValore2) labelValore2.textContent = 'Secondo valore (€)';
                    if (labelValore3) labelValore3.textContent = 'Terzo valore (€)';

                    if (tipo === 'r2') {
                        if (labelValore) labelValore.textContent = 'Attivo realizzato (€)';
                        if (labelValore2) labelValore2.textContent = 'Passivo accertato (€)';
                    }
                    if (tipo === 'r4' || tipo === 'r5_1' || tipo === 'r6') {
                        if (labelValore) labelValore.textContent = 'Componenti positivi di reddito lordi (€)';
                        if (labelValore2) labelValore2.textContent = 'Totale attività (€)';
                        if (labelValore3) labelValore3.textContent = 'Ammontare passività (€)';
                    }
                    if (tipo === 'r3') {
                        if (labelValore) labelValore.textContent = 'Valore perizia / valutazione (€)';
                    }
                    if (tipo === 'r7_1') {
                        if (labelValore) labelValore.textContent = 'Capitale sottoscritto (€)';
                    }
                    if (tipo === 'r7_2') {
                        if (labelValore) labelValore.textContent = 'Totale attività (€)';
                    }
                    if (tipo === 'r8_1') {
                        if (labelValore) labelValore.textContent = 'Corrispettivo pattuito (€)';
                    }
                    if (tipo === 'r8_2') {
                        if (labelValore) labelValore.textContent = 'Capitale mutuato/erogato (€)';
                    }
                    if (tipo === 'r9') {
                        if (labelValore) labelValore.textContent = 'Totale passività (€)';
                    }
                    if (tipo === 'r10_2' || tipo === 'r10_3') {
                        if (labelValore) labelValore.textContent = 'Imposte/tasse/contributi/sanzioni/interessi dovuti (€)';
                    }
                    if (tipo === 'r11') {
                        if (labelValore) labelValore.textContent = 'Redditi + attività (somma) (€)';
                    }
                }
            }

            function pickRate(min, max, criterio) {
                if (criterio === 'min') return min;
                if (criterio === 'max') return max;
                return (min + max) / 2;
            }

            function rateRange(a, b) {
                const minRate = Math.min(a, b);
                const maxRate = Math.max(a, b);
                return { minRate, maxRate };
            }

            function tiered(value, tiers) {
                // tiers: [{ upto, minRate, maxRate }] with progressive application
                let remaining = value;
                let lastCap = 0;
                let minTotal = 0;
                let maxTotal = 0;

                for (const t of tiers) {
                    if (remaining <= 0) break;
                    const cap = t.upto;
                    const span = Math.max(0, Math.min(value, cap) - lastCap);
                    if (span > 0) {
                        minTotal += span * t.minRate;
                        maxTotal += span * t.maxRate;
                    }
                    lastCap = cap;
                }

                // last tier with upto: Infinity
                const last = tiers[tiers.length - 1];
                if (last && last.upto === Infinity) {
                    const span = Math.max(0, value - lastCap);
                    if (span > 0) {
                        minTotal += span * last.minRate;
                        maxTotal += span * last.maxRate;
                    }
                }

                return { minTotal, maxTotal };
            }

            function euro(n) {
                return new Intl.NumberFormat('it-IT', { style: 'currency', currency: 'EUR' }).format(n);
            }

            async function apiRequest(path, options = {}) {
                const token = localStorage.getItem('authToken');
                const headers = Object.assign({ 'Content-Type': 'application/json' }, options.headers || {});
                if (token) headers.Authorization = `Bearer ${token}`;

                const res = await fetch(path, Object.assign({}, options, { headers }));
                let data = null;
                try {
                    data = await res.json();
                } catch {
                    data = null;
                }
                if (!res.ok) {
                    const msg = data && data.error ? data.error : 'Errore server';
                    throw new Error(msg);
                }
                return data;
            }

            async function downloadDocumentPdf(documentId, fileName) {
                const token = localStorage.getItem('authToken');
                const res = await fetch(`/api/documents/${documentId}/download`, {
                    method: 'GET',
                    headers: { Authorization: `Bearer ${token}` }
                });

                if (!res.ok) {
                    let msg = 'Errore download';
                    try {
                        const data = await res.json();
                        if (data && data.error) msg = data.error;
                    } catch {}
                    throw new Error(msg);
                }

                const blob = await res.blob();
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = fileName || `documento-compenso-${documentId}.pdf`;
                document.body.appendChild(a);
                a.click();
                a.remove();
                URL.revokeObjectURL(url);
            }

            function escapeHtml(str) {
                return String(str || '')
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#039;');
            }

            function renderDraftPreview() {
                if (!previewEl) return;

                const nomePratica = nomePraticaEl ? String(nomePraticaEl.value || '').trim() : '';
                const clienteNome = clienteNomeEl ? String(clienteNomeEl.value || '').trim() : '';
                const docText = documentTypeEl && documentTypeEl.selectedIndex > -1
                    ? (documentTypeEl.options[documentTypeEl.selectedIndex].textContent || '')
                    : '';
                const catText = documentCategoryEl && documentCategoryEl.selectedIndex > -1
                    ? (documentCategoryEl.options[documentCategoryEl.selectedIndex].textContent || '')
                    : '';

                const tipo = prestazioneEl ? prestazioneEl.value : '';
                const parts = [];
                if (nomePratica) parts.push(`<div><strong>Nome pratica:</strong> ${escapeHtml(nomePratica)}</div>`);
                if (clienteNome) parts.push(`<div><strong>Cliente / Società:</strong> ${escapeHtml(clienteNome)}</div>`);
                if (docText) parts.push(`<div><strong>Documento:</strong> ${escapeHtml(docText)}</div>`);
                if (catText && (documentCategoryEl && documentCategoryEl.value)) parts.push(`<div><strong>Categoria:</strong> ${escapeHtml(catText)}</div>`);
                if (tipo) parts.push(`<div><strong>Riquadro:</strong> ${escapeHtml(tipo)}</div>`);
                if (criterioEl && criterioEl.value) parts.push(`<div><strong>Criterio:</strong> ${escapeHtml(criterioEl.value)}</div>`);

                const v1 = valoreEl && valoreEl.value ? Number(valoreEl.value) : null;
                const v2 = valore2El && valore2El.value ? Number(valore2El.value) : null;
                const v3 = valore3El && valore3El.value ? Number(valore3El.value) : null;
                if (Number.isFinite(v1)) parts.push(`<div><strong>Valore:</strong> ${escapeHtml(v1)}</div>`);
                if (Number.isFinite(v2)) parts.push(`<div><strong>Valore 2:</strong> ${escapeHtml(v2)}</div>`);
                if (Number.isFinite(v3)) parts.push(`<div><strong>Valore 3:</strong> ${escapeHtml(v3)}</div>`);

                if (!parts.length) {
                    setPreview('Seleziona una sezione e inserisci i dati per vedere l\'anteprima.');
                    return;
                }
                setPreview(parts.join(''));
            }

            function buildPayloadFromForm({ tipo, criterio, min, max, chosen, details }) {
                const multi = document.querySelectorAll('input[name="dich_multi"]:checked');
                const dichiarazioniMulti = Array.from(multi || []).map(el => String(el.value || '')).filter(Boolean);
                const input = {
                    nome_pratica: nomePraticaEl ? String(nomePraticaEl.value || '') : '',
                    cliente_nome: clienteNomeEl ? String(clienteNomeEl.value || '') : '',
                    documentType: documentTypeEl ? documentTypeEl.value : null,
                    documentCategory: documentCategoryEl ? documentCategoryEl.value : null,
                    corrispettivoPattuito: pattuitoEl ? Number(pattuitoEl.value) : null,
                    percentuale: percentualeEl ? Number(percentualeEl.value) : null,
                    valore: Number(valoreEl.value),
                    valore2: Number(valore2El.value),
                    valore3: Number(valore3El.value),
                    dichiarazione: dichiarazioneEl ? dichiarazioneEl.value : null,
                    dichiarazioniMulti,
                    esitoNegativo: esitoNegativoEl ? !!esitoNegativoEl.checked : false,
                    ruoloSindaco: ruoloSindacoEl ? ruoloSindacoEl.value : null,
                    riduzioneComma2: riduzioneComma2El ? !!riduzioneComma2El.checked : false,
                    aliquota_scaglione_1: (aliquotaSc1El && String(aliquotaSc1El.value || '').trim() !== '') ? Number(aliquotaSc1El.value) : null,
                    aliquota_scaglione_2: (aliquotaSc2El && String(aliquotaSc2El.value || '').trim() !== '') ? Number(aliquotaSc2El.value) : null,
                    intensity_scaglione_1: intensitySc1El ? String(intensitySc1El.value || '') : null,
                    intensity_scaglione_2: intensitySc2El ? String(intensitySc2El.value || '') : null,
                    aliquota_consulenza: (aliquotaConsulenzaEl && String(aliquotaConsulenzaEl.value || '').trim() !== '') ? Number(aliquotaConsulenzaEl.value) : null,
                };

                const result = {
                    min: euro(min),
                    max: euro(max),
                    mid: euro((min + max) / 2),
                    chosen: euro(chosen),
                    details,
                };

                return {
                    professione: (professioneEl && professioneEl.value) || 'commercialista',
                    riquadro: tipo,
                    criterio,
                    input,
                    result,
                };
            }

            async function compute() {
                clearFieldErrors();

                const nomePratica = nomePraticaEl ? String(nomePraticaEl.value || '').trim() : '';
                const clienteNome = clienteNomeEl ? String(clienteNomeEl.value || '').trim() : '';
                if (!nomePratica) {
                    showFieldError(nomePraticaEl, 'Inserisci il nome della pratica/compenso.');
                    setStepper(1);
                    renderDraftPreview();
                    return;
                }
                if (!clienteNome) {
                    showFieldError(clienteNomeEl, 'Inserisci il nominativo cliente / ragione sociale.');
                    setStepper(1);
                    renderDraftPreview();
                    return;
                }

                const docType = documentTypeEl ? documentTypeEl.value : '';
                if (!docType) {
                    showFieldError(documentTypeEl, 'Seleziona un documento.');
                    setStepper(1);
                    renderDraftPreview();
                    return;
                }

                const tipo = prestazioneEl ? prestazioneEl.value : '';
                const criterio = criterioEl ? criterioEl.value : 'medio';
                if (!tipo) {
                    setResult('Errore: tipologia non valida.', true);
                    setStepper(1);
                    renderDraftPreview();
                    return;
                }

                const cfg = docConfig[docType] || docConfig.default;

                setStepper(2);

                if (btn) {
                    btn.classList.add('is-loading');
                    btn.disabled = true;
                }
                setResult('Risultato: calcolo in corso...', false);

                try {
                    // Riquadro 10.1: importi fissi
                    if (tipo === 'r10_1') {
                        const fixed = {
                            pf_no_piva: 150,
                            pf_piva: 450,
                            soc_persone: 550,
                            soc_capitali: 650,
                            irap: 200,
                            iva: 250,
                            sostituti: 150,
                            successione: 350,
                            altre: 100,
                            invio: 20,
                        };

                        const checked = document.querySelectorAll('input[name="dich_multi"]:checked');
                        const selected = Array.from(checked || []).map(el => String(el.value || '')).filter(Boolean);
                        if (!selected.length) {
                            showFieldError(groupDichiarazioniMulti, 'Seleziona almeno una voce.');
                            setResult('Errore: seleziona almeno una voce.', true);
                            renderDraftPreview();
                            return;
                        }

                        let amount = 0;
                        const lines = [];
                        selected.forEach(id => {
                            const fee = fixed[id];
                            if (Number.isFinite(fee)) {
                                amount += fee;
                                lines.push(`${id}: ${euro(fee)}`);
                            }
                        });

                        const payload = buildPayloadFromForm({
                            tipo,
                            criterio,
                            min: amount,
                            max: amount,
                            chosen: amount,
                            details: ['Somma tariffe fisse dichiarazioni.'].concat(lines),
                        });
                        btnDownloadPdf.disabled = false;
                        btnDownloadPdf.dataset.payload = JSON.stringify(payload);

                        setResult(`Risultato: Compenso di riferimento ${euro(amount)} | Compenso pattuito ${euro(amount)}`, false);
                        setPreview(`<div><strong>Compenso (${escapeHtml(criterio)}):</strong> ${euro(amount)}</div>`);
                        return;
                    }

                    const v1 = Number(valoreEl && valoreEl.value ? valoreEl.value : 0);
                    const v2 = Number(valore2El && valore2El.value ? valore2El.value : 0);
                    const v3 = Number(valore3El && valore3El.value ? valore3El.value : 0);
                    const v2Missing = !valore2El || String(valore2El.value || '').trim() === '';
                    const v3Missing = !valore3El || String(valore3El.value || '').trim() === '';

                    if (!Number.isFinite(v1) || v1 < 0) {
                        showFieldError(valoreEl, 'Inserisci un valore valido.');
                        setResult('Errore: valore non valido.', true);
                        renderDraftPreview();
                        return;
                    }

                    if (tipo === 'r2' && (v2Missing || !Number.isFinite(v2) || v2 < 0)) {
                        showFieldError(valore2El, 'Inserisci anche il secondo valore.');
                        setResult('Errore: secondo valore mancante.', true);
                        renderDraftPreview();
                        return;
                    }

                    if (tipo === 'r1' && cfg && cfg.show && cfg.show.v2 && (v2Missing || !Number.isFinite(v2) || v2 < 0)) {
                        showFieldError(valore2El, 'Inserisci anche il totale attività.');
                        setResult('Errore: secondo valore mancante.', true);
                        renderDraftPreview();
                        return;
                    }

                    if (tipo === 'r11' && cfg && cfg.show && cfg.show.v2 && (v2Missing || !Number.isFinite(v2) || v2 < 0)) {
                        showFieldError(valore2El, 'Inserisci anche il totale attività.');
                        setResult('Errore: secondo valore mancante.', true);
                        renderDraftPreview();
                        return;
                    }

                    if (['r4', 'r5_1', 'r6'].includes(tipo) && (v2Missing || v3Missing || !Number.isFinite(v2) || v2 < 0 || !Number.isFinite(v3) || v3 < 0)) {
                        showFieldError(valore2El, 'Valore 2 richiesto.');
                        showFieldError(valore3El, 'Valore 3 richiesto.');
                        setResult('Errore: valori aggiuntivi mancanti.', true);
                        renderDraftPreview();
                        return;
                    }

                    let min = 0;
                    let max = 0;
                    const details = [];

                    if (tipo === 'r1') {
                        const needsV2 = cfg && cfg.show && cfg.show.v2;
                        const base = needsV2 ? (v1 + v2) : v1;
                        const t = tiered(base, [
                            { upto: 10000, ...rateRange(0.03, 0.04) },
                            { upto: 50000, ...rateRange(0.02, 0.03) },
                            { upto: Infinity, ...rateRange(0.01, 0.02) },
                        ]);
                        min = t.minTotal;
                        max = t.maxTotal;
                        details.push(needsV2 ? 'Base: reddito lordo + totale attività (somma).' : 'Base: valore di riferimento.');
                    } else if (tipo === 'r2') {
                        const attivo = tiered(v1, [
                            { upto: 400000, ...rateRange(0.04, 0.06) },
                            { upto: 4000000, ...rateRange(0.02, 0.03) },
                            { upto: Infinity, ...rateRange(0.0075, 0.01) },
                        ]);
                        const passivo = {
                            minTotal: v2 * 0.0075,
                            maxTotal: v2 * 0.01,
                        };
                        min = attivo.minTotal + passivo.minTotal;
                        max = attivo.maxTotal + passivo.maxTotal;
                        details.push('Valore 1: attivo realizzato.');
                        details.push('Valore 2: passivo accertato.');
                    } else if (tipo === 'r3') {
                        const t = tiered(v1, [
                            { upto: 1000000, ...rateRange(0.008, 0.01) },
                            { upto: 3000000, ...rateRange(0.005, 0.007) },
                            { upto: Infinity, ...rateRange(0.00025, 0.0005) },
                        ]);
                        min = t.minTotal;
                        max = t.maxTotal;
                        details.push('Base: valore della perizia o valutazione.');
                    } else if (tipo === 'r4') {
                        const redditiMin = v1 * 0.001;
                        const redditiMax = v1 * 0.0015;
                        const attivitaMin = v2 * 0.0005;
                        const attivitaMax = v2 * 0.00075;
                        const passivitaMin = v3 * 0.0005;
                        const passivitaMax = v3 * 0.00075;
                        min = redditiMin + attivitaMin + passivitaMin;
                        max = redditiMax + attivitaMax + passivitaMax;
                        details.push('Base 1: redditi lordi.');
                        details.push('Base 2: totale attività.');
                        details.push('Base 3: ammontare passività.');
                    } else if (tipo === 'r5_1') {
                        const redditiMin = v1 * 0.003;
                        const redditiMax = v1 * 0.005;
                        const attivitaMin = v2 * 0.0002;
                        const attivitaMax = v2 * 0.0006;
                        const passivitaMin = v3 * 0.0002;
                        const passivitaMax = v3 * 0.00065;
                        min = redditiMin + attivitaMin + passivitaMin;
                        max = redditiMax + attivitaMax + passivitaMax;
                        details.push('Base 1: redditi lordi.');
                        details.push('Base 2: totale attività.');
                        details.push('Base 3: totale passività.');
                    } else if (tipo === 'r5_2') {
                        const t = tiered(v1, [
                            { upto: 50000, ...rateRange(0.03, 0.04) },
                            { upto: 100000, ...rateRange(0.01, 0.02) },
                            { upto: Infinity, ...rateRange(0.005, 0.01) },
                        ]);
                        min = t.minTotal;
                        max = t.maxTotal;
                        details.push('Base: redditi lordi (scaglioni).');
                    } else if (tipo === 'r6') {
                        const redditi = tiered(v1, [
                            { upto: 20000000, ...rateRange(0.0002, 0.0003) },
                            { upto: Infinity, ...rateRange(0.00005, 0.0001) },
                        ]);
                        const attivitaMin = v2 * 0.0005;
                        const attivitaMax = v2 * 0.0006;
                        const passivitaMin = v3 * 0.0002;
                        const passivitaMax = v3 * 0.0003;
                        min = redditi.minTotal + attivitaMin + passivitaMin;
                        max = redditi.maxTotal + attivitaMax + passivitaMax;
                        details.push('Base 1: redditi lordi (scaglioni).');
                        details.push('Base 2: totale attività.');
                        details.push('Base 3: ammontare passività.');
                    } else if (tipo === 'r7_1') {
                        const t = tiered(v1, [
                            { upto: 1000000, ...rateRange(0.0075, 0.015) },
                            { upto: 15000000, ...rateRange(0.005, 0.0075) },
                            { upto: Infinity, ...rateRange(0.0025, 0.005) },
                        ]);
                        min = t.minTotal;
                        max = t.maxTotal;
                        details.push('Base: capitale sottoscritto.');
                    } else if (tipo === 'r7_2') {
                        const t = tiered(v1, [
                            { upto: 4000000, ...rateRange(0.01, 0.015) },
                            { upto: Infinity, ...rateRange(0.005, 0.01) },
                        ]);
                        min = t.minTotal;
                        max = t.maxTotal;
                        details.push('Base: totale attività.');
                    } else if (tipo === 'r8_1') {
                        const hasCustomRates = !!(cfg && cfg.show && cfg.show.aliquotaSc1);
                        if (hasCustomRates) {
                            const a1 = aliquotaSc1El && aliquotaSc1El.value !== '' ? Number(aliquotaSc1El.value) : 0.0075;
                            const a2 = aliquotaSc2El && aliquotaSc2El.value !== '' ? Number(aliquotaSc2El.value) : 0.005;

                            if (!Number.isFinite(a1) || a1 < 0.0075 || a1 > 0.02) {
                                showFieldError(aliquotaSc1El, 'Aliquota non valida (0,0075 - 0,02).');
                                setResult('Errore: aliquota fascia 1 non valida.', true);
                                renderDraftPreview();
                                return;
                            }
                            if (!Number.isFinite(a2) || a2 < 0.005 || a2 > 0.0075) {
                                showFieldError(aliquotaSc2El, 'Aliquota non valida (0,005 - 0,0075).');
                                setResult('Errore: aliquota fascia 2 non valida.', true);
                                renderDraftPreview();
                                return;
                            }

                            const s1 = Math.min(v1, 2000000);
                            const s2 = Math.max(0, v1 - 2000000);
                            min = (s1 * a1) + (s2 * a2);
                            max = min;
                            details.push('Base: corrispettivo pattuito.');
                            details.push(`Aliquota fascia 1 applicata: ${(a1 * 100).toFixed(2)}%.`);
                            details.push(`Aliquota fascia 2 applicata: ${(a2 * 100).toFixed(2)}%.`);
                        } else {
                            const t = tiered(v1, [
                                { upto: 2000000, ...rateRange(0.0075, 0.02) },
                                { upto: Infinity, ...rateRange(0.005, 0.0075) },
                            ]);
                            min = t.minTotal;
                            max = t.maxTotal;
                            details.push('Base: corrispettivo pattuito.');
                        }
                    } else if (tipo === 'r8_2') {
                        const hasIntensity = !!(cfg && cfg.show && cfg.show.intensitySc1);
                        if (hasIntensity) {
                            function rateFromIntensity(minRate, maxRate, intensity) {
                                if (intensity === 'min') return minRate;
                                if (intensity === 'max') return maxRate;
                                return (minRate + maxRate) / 2;
                            }

                            const i1 = intensitySc1El ? String(intensitySc1El.value || 'min') : 'min';
                            const i2 = intensitySc2El ? String(intensitySc2El.value || 'min') : 'min';
                            const valid = ['min', 'medio', 'max'];
                            if (!valid.includes(i1)) {
                                showFieldError(intensitySc1El, 'Seleziona Minimo, Medio o Massimo.');
                                setResult('Errore: intensità fascia 1 non valida.', true);
                                renderDraftPreview();
                                return;
                            }
                            if (!valid.includes(i2)) {
                                showFieldError(intensitySc2El, 'Seleziona Minimo, Medio o Massimo.');
                                setResult('Errore: intensità fascia 2 non valida.', true);
                                renderDraftPreview();
                                return;
                            }

                            const s1 = Math.min(v1, 2000000);
                            const s2 = Math.max(0, v1 - 2000000);
                            const r1 = rateFromIntensity(0.0075, 0.01, i1);
                            const r2 = rateFromIntensity(0.005, 0.0075, i2);
                            const total = (s1 * r1) + (s2 * r2);
                            min = total;
                            max = total;
                            details.push('Base: capitale mutuato/finanziato/contributi.');
                            details.push(`Intensità fascia 1: ${i1.toUpperCase()} (aliquota ${(r1 * 100).toFixed(2)}%).`);
                            details.push(`Intensità fascia 2: ${i2.toUpperCase()} (aliquota ${(r2 * 100).toFixed(2)}%).`);
                        } else {
                            const t = tiered(v1, [
                                { upto: 2000000, ...rateRange(0.0075, 0.01) },
                                { upto: Infinity, ...rateRange(0.005, 0.0075) },
                            ]);
                            min = t.minTotal;
                            max = t.maxTotal;
                            details.push('Base: capitale mutuato/erogato.');
                        }
                    } else if (tipo === 'r9') {
                        const t = tiered(v1, [
                            { upto: 1000000, ...rateRange(0.01, 0.02) },
                            { upto: Infinity, ...rateRange(0.007, 0.009) },
                        ]);
                        min = t.minTotal;
                        max = t.maxTotal;
                        if (esitoNegativoEl && esitoNegativoEl.checked) {
                            min = min / 2;
                            max = max / 2;
                            details.push('Riduzione applicata: esito negativo (fino alla metà).');
                        }
                        details.push('Base: totale passività.');
                    } else if (tipo === 'r10_2' || tipo === 'r10_3') {
                        min = v1 * 0.01;
                        max = v1 * 0.05;

                        if (tipo === 'r10_3' && cfg && cfg.show && cfg.show.aliquotaConsulenza) {
                            const a = aliquotaConsulenzaEl && aliquotaConsulenzaEl.value !== '' ? Number(aliquotaConsulenzaEl.value) : 0.01;
                            if (!Number.isFinite(a) || a < 0.01 || a > 0.05) {
                                showFieldError(aliquotaConsulenzaEl, 'Aliquota non valida (0,01 - 0,05).');
                                setResult('Errore: aliquota non valida.', true);
                                renderDraftPreview();
                                return;
                            }

                            const custom = v1 * a;
                            min = v1 * 0.01;
                            max = v1 * 0.05;
                            details.push('Base: imposte/sanzioni/interessi in contestazione.');
                            details.push(`Aliquota selezionata: ${(a * 100).toFixed(2)}%.`);
                            // Usiamo il valore personalizzato come riferimento (chosen)
                            const chosenCustom = custom;
                            const chosen = chosenCustom;
                            const pct = percentualeEl && percentualeEl.value !== '' ? Number(percentualeEl.value) : NaN;
                            if (Number.isFinite(pct) && pct >= 0 && pct <= 100) {
                                details.push(`Percentuale inserita: ${pct}%. (Non applicata: è già stata selezionata un'aliquota specifica)`);
                            }

                            const pattuitoNum = pattuitoEl && pattuitoEl.value !== '' ? Number(pattuitoEl.value) : NaN;
                            const compensoPattuito = Number.isFinite(pattuitoNum) && pattuitoNum >= 0 ? pattuitoNum : chosen;

                            const payload = buildPayloadFromForm({ tipo, criterio, min, max, chosen, details });
                            payload.result.compenso_pattuito = euro(compensoPattuito);

                            btnDownloadPdf.disabled = false;
                            btnDownloadPdf.dataset.payload = JSON.stringify(payload);

                            setResult(`Risultato: Compenso di riferimento ${euro(chosen)} | Compenso pattuito ${euro(compensoPattuito)}`, false);

                            const detailHtml = details.length
                                ? `<div style="margin-top:10px;"><strong>Dettagli</strong><br>${details.map(d => `- ${escapeHtml(d)}`).join('<br>')}</div>`
                                : '';
                            setPreview([
                                `<div><strong>Valore personalizzato:</strong> ${euro(chosen)}</div>`,
                                `<div><strong>Range ministeriale:</strong> ${euro(min)} - ${euro(max)}</div>`,
                                detailHtml,
                            ].join(''));
                            return;
                        }

                        details.push('Base: importi dovuti.');
                    } else if (tipo === 'r11') {
                        const baseMin = 6000;
                        const baseMax = 8000;
                        const needsV2 = cfg && cfg.show && cfg.show.v2;
                        const x = needsV2 ? (v1 + v2) : v1;
                        let extraMin = 0;
                        let extraMax = 0;
                        const cap1 = 5000000;
                        const cap2 = 100000000;
                        const cap3 = 300000000;
                        const cap4 = 800000000;
                        if (x > cap1) {
                            const s1 = Math.min(x, cap2) - cap1;
                            if (s1 > 0) {
                                extraMin += s1 * 0.00009;
                                extraMax += s1 * 0.00010;
                            }
                        }
                        if (x > cap2) {
                            const s2 = Math.min(x, cap3) - cap2;
                            if (s2 > 0) {
                                extraMin += s2 * 0.00006;
                                extraMax += s2 * 0.00009;
                            }
                        }
                        if (x > cap3) {
                            const s3 = Math.min(x, cap4) - cap3;
                            if (s3 > 0) {
                                extraMin += s3 * 0.00005;
                                extraMax += s3 * 0.00006;
                            }
                        }
                        if (x > cap4) {
                            const over = x - cap4;
                            const steps = Math.ceil(over / 100000000);
                            extraMin += steps * 7500;
                            extraMax += steps * 10000;
                        }
                        min = baseMin + extraMin;
                        max = baseMax + extraMax;
                        details.push(needsV2 ? 'Base: sommatoria reddito lordo + attività (somma).' : 'Base: valore di riferimento.');

                        const ruolo = ruoloSindacoEl ? String(ruoloSindacoEl.value || '') : '';
                        let roleFactor = 1;
                        if (ruolo === 'presidente') roleFactor = 1.5;
                        if (ruolo === 'sindaco_unico') roleFactor = 2;
                        if (roleFactor !== 1) {
                            min = min * roleFactor;
                            max = max * roleFactor;
                            details.push(ruolo === 'presidente'
                                ? 'Aumento applicato: Presidente Collegio Sindacale (+50%).'
                                : 'Aumento applicato: Sindaco Unico (+100%).');
                        }

                        if (riduzioneComma2El && riduzioneComma2El.checked) {
                            min = min / 2;
                            max = max / 2;
                            details.push('Riduzione applicata: società di sola amministrazione/godimento o liquidazione (fino alla metà).');
                        }
                    } else {
                        setResult('Errore: tipologia non gestita.', true);
                        renderDraftPreview();
                        return;
                    }

                    const pct = percentualeEl && percentualeEl.value !== '' ? Number(percentualeEl.value) : NaN;
                    let chosen = pickRate(min, max, criterio);
                    if (Number.isFinite(pct) && pct >= 0 && pct <= 100 && max > min) {
                        chosen = min + ((max - min) * (pct / 100));
                        details.push(`Percentuale applicata nel range ministeriale: ${pct}%.`);
                    }

                    const pattuitoNum = pattuitoEl && pattuitoEl.value !== '' ? Number(pattuitoEl.value) : NaN;
                    const compensoPattuito = Number.isFinite(pattuitoNum) && pattuitoNum >= 0 ? pattuitoNum : chosen;

                    const payload = buildPayloadFromForm({ tipo, criterio, min, max, chosen, details });
                    payload.result.compenso_pattuito = euro(compensoPattuito);

                    btnDownloadPdf.disabled = false;
                    btnDownloadPdf.dataset.payload = JSON.stringify(payload);

                    setResult(`Risultato: Compenso di riferimento ${euro(chosen)} | Compenso pattuito ${euro(compensoPattuito)}`, false);

                    const detailHtml = details.length
                        ? `<div style="margin-top:10px;"><strong>Dettagli</strong><br>${details.map(d => `- ${escapeHtml(d)}`).join('<br>')}</div>`
                        : '';
                    setPreview([
                        `<div><strong>Compenso (${escapeHtml(criterio)}):</strong> ${euro(chosen)}</div>`,
                        `<div><strong>Range:</strong> ${euro(min)} - ${euro(max)}</div>`,
                        detailHtml,
                    ].join(''));
                } finally {
                    if (btn) {
                        btn.classList.remove('is-loading');
                        btn.disabled = false;
                    }
                }
            }

            if (documentTypeEl) {
                documentTypeEl.addEventListener('change', () => {
                    applyDocType();
                    setStepper(1);
                    renderDraftPreview();
                });
            }

            if (documentCategoryEl) {
                documentCategoryEl.addEventListener('change', () => {
                    applyCategory();
                    setStepper(1);
                    renderDraftPreview();
                });
            }

            if (btn) {
                btn.addEventListener('click', compute);
            }

            if (btnDownloadPdf) {
                btnDownloadPdf.addEventListener('click', async () => {
                    try {
                        const raw = btnDownloadPdf.dataset.payload;
                        if (!raw) {
                            setResult('Errore: esegui prima il calcolo.', true);
                            return;
                        }

                        btnDownloadPdf.disabled = true;
                        btnDownloadPdf.textContent = 'GENERAZIONE PDF...';

                        const payload = JSON.parse(raw);
                        const data = await apiRequest('/api/calculations', {
                            method: 'POST',
                            body: JSON.stringify(payload)
                        });

                        const docId = data && (data.document_id || data.documentId);
                        if (!docId) {
                            throw new Error('Risposta non valida dal server');
                        }

                        function safePart(v) {
                            return String(v || '')
                                .trim()
                                .replace(/\s+/g, '_')
                                .replace(/[^a-zA-Z0-9_-]/g, '')
                                .replace(/_+/g, '_')
                                .replace(/^_+|_+$/g, '');
                        }

                        const np = payload && payload.input ? payload.input.nome_pratica : '';
                        const cn = payload && payload.input ? payload.input.cliente_nome : '';
                        const p1 = safePart(np);
                        const p2 = safePart(cn);
                        const suggested = (p1 && p2)
                            ? `${p1}_${p2}.pdf`
                            : (p1 ? `${p1}.pdf` : (p2 ? `${p2}.pdf` : `documento-compenso-${docId}.pdf`));

                        await downloadDocumentPdf(docId, suggested);
                        setStepper(3);
                    } catch (e) {
                        setResult((e && e.message) ? e.message : 'Errore', true);
                    } finally {
                        btnDownloadPdf.textContent = 'GENERA E SCARICA PDF';
                        btnDownloadPdf.disabled = false;
                    }
                });
            }

            setBlockVisible(groupPattuito, true);
            setBlockVisible(groupPercentuale, true);

            applyDocType();
            setStepper(1);
            renderDraftPreview();
        })();

        function parseJwt(token) {
            if (!token || typeof token !== 'string') return {};
            const parts = token.split('.');
            if (parts.length !== 3) return {};
            try {
                return JSON.parse(atob(parts[1].replace(/-/g, '+').replace(/_/g, '/')));
            } catch {
                return {};
            }
        }

        async function updateHeaderUser() {
            const token = localStorage.getItem('authToken');
            const user = parseJwt(token);
            const headerUl = document.querySelector('.ls ul');
            if (!headerUl) return;
            const isLogged = !!token && (!!user.sub || !!user.id || !!user.email);

            function initialsFrom(u) {
                const nome = (u && u.nome ? String(u.nome) : '').trim();
                const cognome = (u && u.cognome ? String(u.cognome) : '').trim();
                if (nome || cognome) {
                    return `${nome.charAt(0)}${cognome.charAt(0)}`.toUpperCase();
                }
                const email = (u && u.email ? String(u.email) : '').trim();
                if (email) return email.charAt(0).toUpperCase();
                return 'U';
            }

            async function syncNavAvatar() {
                const img = document.getElementById('nav-user-photo');
                const initials = document.querySelector('.nav-user-initials');
                if (!img || !initials) return;

                let u = user || {};
                try {
                    const me = await apiRequest('/api/me', { method: 'GET' });
                    if (me && me.user) u = me.user;
                } catch {
                    u = user || {};
                }

                const avatarUrl = u && u.avatar_url ? String(u.avatar_url) : '';
                if (avatarUrl) {
                    img.src = avatarUrl;
                    img.style.display = '';
                    initials.style.display = 'none';
                } else {
                    img.removeAttribute('src');
                    img.style.display = 'none';
                    initials.textContent = initialsFrom(u);
                    initials.style.display = '';
                }
            }

            function isAuthLi(li) {
                const txt = (li.textContent || '').trim().toLowerCase();
                if (txt === 'login' || txt === 'registrati') return true;
                const btn = li.querySelector('button');
                if (btn && btn.onclick) {
                    const fn = btn.onclick.toString();
                    if (fn.includes('login') || fn.includes('openRegisterModal') || fn.includes('register')) return true;
                }
                const a = li.querySelector('a');
                if (a) {
                    const href = (a.getAttribute('href') || '').toLowerCase();
                    if (href.includes('login') || href.includes('register')) return true;
                }
                return false;
            }

            if (isLogged) {
                headerUl.querySelectorAll('li').forEach(li => {
                    if (isAuthLi(li)) li.style.display = 'none';
                });
                if (!headerUl.querySelector('.user-item')) {
                    const userLi = document.createElement('li');
                    userLi.className = 'user-item';
                    userLi.innerHTML = `
                        <div class="user-dropdown">
                            <button class="user-btn" onclick="toggleUserDropdown(event)">
                                <span class="user-avatar navbar-avatar-circle"><img id="nav-user-photo" class="nav-user-photo" alt="Foto profilo"><span class="nav-user-initials"></span></span>
                                <span class="user-welcome-text">Ciao, ${user.nome || user.email || ''}</span>
                            </button>
                            <div id="userDropdownMenu" class="user-dropdown-menu">
                                <div class="user-menu-info">
                                    <div class="user-menu-avatar-lg"><i class="fas fa-user"></i></div>
                                    <div>
                                        <div class="user-menu-name">${(user.nome || '').trim() ? `Ciao, ${user.nome}` : 'Account'}</div>
                                        <div class="user-menu-email">${user.email || ''}</div>
                                    </div>
                                </div>
                                <div class="user-menu-items">
                                    <button class="user-menu-item" onclick="window.location.href='dashboard.html?view=profile'"><i class="fas fa-user"></i><span>Il mio Profilo</span></button>
                                    <button class="user-menu-item" onclick="window.location.href='dashboard.html?view=calculations'"><i class="fas fa-history"></i><span>I miei Calcoli</span></button>
                                    <button class="user-menu-item" onclick="window.location.href='dashboard.html?view=security'"><i class="fas fa-gear"></i><span>Impostazioni</span></button>
                                </div>
                                <div class="user-menu-footer">
                                    <button class="user-menu-item danger" onclick="handleLogout()"><i class="fas fa-right-from-bracket"></i><span>Esci / Logout</span></button>
                                </div>
                            </div>
                        </div>
                    `;
                    headerUl.appendChild(userLi);
                }
                await syncNavAvatar();
            } else {
                headerUl.querySelectorAll('li').forEach(li => {
                    if (isAuthLi(li)) li.style.display = '';
                });
                const userLi = headerUl.querySelector('.user-item');
                if (userLi) userLi.remove();
            }
        }

        function toggleUserDropdown(event) {
            if (event) event.stopPropagation();
            const menu = document.getElementById('userDropdownMenu');
            if (!menu) return;
            menu.classList.toggle('open');
        }

        function handleLogout() {
            localStorage.removeItem('authToken');
            updateHeaderUser();
            window.location.href = 'index.html';
        }

        function openProfileModal() {
            window.location.href = 'index.html?profile=1';
        }

        document.addEventListener('click', function(event) {
            if (!event.target.closest('.user-dropdown')) {
                const menu = document.getElementById('userDropdownMenu');
                if (menu) menu.classList.remove('open');
            }
        });

        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const menu = document.getElementById('userDropdownMenu');
                if (menu) menu.classList.remove('open');
            }
        });

        (function() {
            updateHeaderUser();
        })();
    </script>

</body>
</html>
